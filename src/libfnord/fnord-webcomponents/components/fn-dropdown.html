<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<style>
  fn-dropdown {
    display: block;
  }

  fn-dropdown[data-style~="inline"] {
    display: inline-block;
  }

</style>

<template id="fn-dropdown-base-tpl">
  <ul id="menu">
  </ul>
</template>

<script type="text/javascript">
  var DropDownComponent = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate("fn-dropdown", "base");
      this.appendChild(tpl);
      var base = this;

      /* options */

      if (this.hasAttribute('data-preselected')) {this.setPreselection();}
      if (this.hasAttribute('data-searchable')) {this.renderSearchInput();}

      this.attributeChangedCallback();

      this.addEventListener('click', function(e) {
        e.stopPropagation();
        base.toggleDisplayDropdown();
      }, false);

      document.addEventListener('click', function() {
        base.hideDropdown();
      }, false);

    };

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      switch (attr) {
        case "data-active":
          this.renderDropdown();
          break;
        case "data-style":
          this.setStyle();
          break;
        case "data-state":
          this.setState(new_val);
          break;
        case "data-preselected":
          this.setPreselection();
          break;
        case 'data-select':
          this.options.select = new_val;
          break;
        default:
          break;
      }
    };

    /* styles currently can't be removed by changing the attribute */
    this.setStyle = function() {
      var dropdown_ui = this.shadowRoot.querySelector("#dropdown_ui");
      var class_name = this.getAttribute('data-style');

      if (this.querySelector("fn-dropdown-label") != null) {
        class_name += " labeled";
      }

      dropdown_ui.className = class_name;
    };

    /* states can be added and removed */
    this.setState = function() {
      var dropdown_ui = this.shadowRoot.querySelector("#dropdown_ui");
      dropdown_ui.setAttribute("data-state", this.getAttribute('data-state'));
    };

    /* preselection only works if data-value is set */
    this.setPreselection = function() {
      var value = this.getAttribute('data-preselected');
      var item = this.querySelector(
        "fn-dropdown-item[data-value='" + value + "']");

      if (item != null) {
        var text = item.innerHTML;
        this.updateHeader(text);
        item.setAttribute('data-active', true);
      }
    };

    this.renderSearchInput = function() {
      this.search_item = "";
      var input = document.createElement("input");
      var placeholder = this.getAttribute('data-placeholder');
      if (placeholder != null) {
        input.placeholder = placeholder;
      }
      var dropdown_ui = this.shadowRoot.querySelector("#dropdown_ui");
      dropdown_ui.className = "input search";
      var header = this.shadowRoot.querySelector(".header");
      dropdown_ui.insertBefore(input, header);

      var base = this;

      input.addEventListener('click', function() {
        base.search_item = "";
      }, false);

      input.addEventListener('keyup', function(e) {
        switch (e.keyCode) {
          case 38:
            base.keyNavigationUp();
            break;
          case 40:
            base.keyNavigationDown();
            break;
          case 13:
            base.keyNavigationSubmit();
            break;
          default:
            base.search_item = this.value.toLowerCase();
            base.renderDropdown();
            break;
        }
      }, false);
    };

    this.toggleDisplayDropdown = function() {
      var ul = this.shadowRoot.querySelector("ul");
      if (ul.hasAttribute("data-active")) {
        this.hideDropdown();
      } else {
        if (this.getAttribute('data-state') != "disabled") {
          this.renderDropdown();
        }
      }
    };

    this.hideDropdown = function() {
      var list = this.shadowRoot.querySelector("ul");
      list.removeAttribute("data-active");
      this.removeAttribute("data-active");
    };

    this.renderListLabel = function(label, list_elem) {
      var list_item = document.createElement("li");
      list_item.className = "label";
      list_item.innerHTML = label;
      list_elem.appendChild(list_item);
    };



    this.onCheckboxItemClick = function(base, item, shadow) {
      console.log("checkbox item lcicked");
      item.setAttribute('data-active', true);
      console.log(shadow);
    }

    this.onItemClick = function(base, item, shadow) {
      var active_items = base.querySelectorAll("fn-dropdown-item[data-active]");
      for (var i = 0; i < active_items.length; ++i) {
        active_items[i].removeAttribute("data-active");
      }

      var active_shadow_items = base.shadowRoot.querySelectorAll(
          "li.item[data-active]");
      for (var i = 0; i < active_shadow_items.length; ++i) {
        active_shadow_items[i].removeAttribute("data-active");
      }

      shadow.setAttribute("data-active", true);
      item.setAttribute("data-active", true);

      var ev = new CustomEvent("fn-dropdown-item-click", {
        bubbles: true,
        cancelable: true
      });
      item.dispatchEvent(ev);

      base.updateHeader(shadow.innerText);
      base.hideDropdown();
    };

    this.updateHeader = function(text) {
      var header = this.querySelector("fn-dropdown-header");
      if (header != null && header.getAttribute('data-display-selection') == 'false') {return;}

      if (this.hasAttribute('data-searchable')) {
        this.shadowRoot.querySelector("input").value = text;
      } else {
        var shadow_header = this.shadowRoot.querySelector(".header .text");
        shadow_header.innerHTML = text;
      }
    };

    /* Searchable Dropdown Key Navigation */
    this.keyNavigationUp = function() {
      var hover_elem = this.shadowRoot.querySelector("li[hover]");
      if (hover_elem != null) {
        var index = parseInt(hover_elem.getAttribute('data-index'), 10) - 1;
        var elem = this.shadowRoot.querySelector("li[data-index='" + index + "']");
        if (elem != null) {
          hover_elem.removeAttribute("hover");
          elem.setAttribute("hover", "hover");
          this.shadowRoot.querySelector("ul").scrollTop = elem.offsetTop;
        }
      }
    };

    this.keyNavigationDown = function() {
      var hover_elem = this.shadowRoot.querySelector("li[hover]");
      if (hover_elem != null) {
        var index = parseInt(hover_elem.getAttribute('data-index'), 10) + 1;
        var elem = this.shadowRoot.querySelector("li[data-index='" + index + "']");
        if (elem != null) {
          hover_elem.removeAttribute("hover");
          elem.setAttribute("hover", "hover");
          this.shadowRoot.querySelector("ul").scrollTop = elem.offsetTop;
        }
      } else {
        var elem = this.shadowRoot.querySelector("li[data-index='0']");
        elem.setAttribute("hover", "hover");
      }
    };

    this.keyNavigationSubmit = function() {
      var shadow_elem = this.shadowRoot.querySelector("li[hover]");
      if (shadow_elem != null) {
        var value = shadow_elem.innerText;
        var item = this.querySelector(
          "fn-dropdown-item[data-value='" + value + "']");
        this.clickItem(item, shadow_elem);
      }
    };

  };

  window.addEventListener("fn-ready", function() {
    Fnord.registerComponent("fn-dropdown", DropDownComponent);
  }, false);
</script>
