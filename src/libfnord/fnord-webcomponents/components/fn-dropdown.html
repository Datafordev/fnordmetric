<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<script type="text/javascript">
  var DropDownComponent = function() {
    this.createdCallback = function() {
      var base = this;

      //Remove?
      document.addEventListener('click', function() {
        base.hideDropdown();
      }, false);


      if (this.hasAttribute('data-resolved')) {
        this.initHeaderItem();
      }
    };

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      if (attr == 'data-resolved') {
        this.initHeaderItem();
      }
    };

    // Checks if a header_elem exists and renders one if not
    this.initHeaderItem = function() {
      if (this.querySelector("fn-dropdown-input")) {
        return this.renderSearchable();
      }

      var base = this;
      var selected_item = this.querySelector("fn-dropdown-item[data-selected]");
      var header_elem = this.querySelector("fn-dropdown-header");
      var preselection = this.getAttribute('data-preselected');

      if (!selected_item) {
        if (preselection) {
          selected_item = this.findItemByValue(preselection);
        }

        if (!selected_item) {
          selected_item = this.querySelector("fn-dropdown-item");
        }

        selected_item.setAttribute('data-selected', 'selected');
      }

      if (!header_elem) {
        header_elem = document.createElement("fn-dropdown-header");
        this.insertBefore(header_elem, this.firstChild);
      }

      var onClick = function(e) {
        e.stopPropagation();
        base.toggleDropdown();
      };

      this.setHeaderValue();
      header_elem.addEventListener('click', onClick, false);
    };

    // Copies the selected items html to the header_elem
    this.setHeaderValue = function() {
      this.querySelector("fn-dropdown-header").innerHTML =
        this.querySelector("fn-dropdown-item[data-selected]").innerHTML;
    };

    this.toggleDropdown = function() {
      if (this.querySelector("fn-dropdown-items").hasAttribute('data-active')) {
        this.hideDropdown();
      } else {
        this.showDropdown();
      }
    };

    this.hideDropdown = function() {
      var items = this.querySelector("fn-dropdown-items");
      if (items) {
        items.removeAttribute('data-active');
      }

      //remove global event listener
      if (this.keyEventListener.target == window) {
        this.handleKeyNavigation(false);
      }
    };

    this.showDropdown = function() {
      if (this.classList.contains("disabled")) {
        return;
      }

      var menu = this.querySelector("fn-dropdown-items");
      menu.setAttribute('data-active', 'active');

      if (!this.eventListeners) {
        //set eventListeners only once
        this.setItemEventListeners();
      }

      //set global event listener if not searchable
      if (!this.keyEventListener || this.keyEventListener.target == window) {
        this.handleKeyNavigation(true);
      }
    };

    this.findItemByValue = function(value) {
      return (this.querySelector(
        "fn-dropdown-item[data-value='" + value + "']"));
    };

    this.setItemEventListeners = function() {
      var base = this;
      var items = this.querySelectorAll("fn-dropdown-item");

      for (var i = 0; i < items.length; i++) {
        items[i].onclick = function() {
          base.onItemClick(this);
        }
      }

      this.eventListeners = true;
    };

    this.onItemClick = function(item) {
      var prev_item = this.querySelector("fn-dropdown-item[data-selected]");
      var input_elem = this.querySelector("fn-input");

      if (prev_item) {
        prev_item.removeAttribute('data-selected');
      }

      item.setAttribute("data-selected", 'selected');

      if (input_elem) {
        input_elem.setAttribute('data-value', item.innerHTML);
      } else {
        this.setHeaderValue();
      }

      this.hideDropdown();
      this.fireClickEvent(item);
    };

    this.fireClickEvent = function(item) {
      var ev = new CustomEvent("fn-dropdown-item-click", {
        detail : {'text' : item.innerText},
        bubbles: true,
        cancelable: true
      });
      item.dispatchEvent(ev);
    };


    /*********************** Key Navigation **********************************/

    this.handleKeyNavigation = function(set) {
      var input = this.querySelector("fn-input");
      //set key event for input if searchable and for window otherwise
      var elem = input ? input : window;
      var base = this;

      var listener = function(e) {
        e.preventDefault();
        switch (e.keyCode) {
          case 38:
            base.keyNavigation('up');
            break;
          case 40:
            base.keyNavigation('down');
            break;
          case 13:
            base.onItemClick(base.querySelector("fn-dropdown-item.hover"));
            break;
          default:
            if (input) {
              base.showFilteredDropdownItems(input.getValue());
            }
            break;
        }
      }

      if (set) {
        elem.addEventListener('keyup', listener, false);
        this.keyEventListener = {'set' : true, 'target' : elem};
      } else {
        elem.removeEventListener('keyup', listener, false);
        this.keyEventListener.set = false;
      }
    }

    this.keyNavigation = function(direction) {
      var hover_elem = this.querySelector("fn-dropdown-item.hover");
      var ref_elem;
      var elem = null;
      var items = this.querySelectorAll("fn-dropdown-item");

      if (!hover_elem) {
        if (direction == 'down') {
          //filtered Dropdown can contain hidden items
          if (items[0].classList.contains('hidden')) {
            hover_elem = items[0];
          } else {
            items[0].classList.add('hover');
            return;
          }
        }
      }

      ref_elem = hover_elem;
      for (var i = 0; i < items.length; i++) {
        if (direction == 'down') {
          elem = ref_elem.nextElementSibling;
          if (!elem) {
            elem = items[0];
          }
        } else {
          elem = ref_elem.previousElementSibling;
          if (!elem) {
            return;
          }
        }

        if (elem.classList.contains('hidden')) {
          ref_elem = elem;
        } else {
          elem.classList.add('hover');
          hover_elem.classList.remove('hover');
          return;
        }
      }
    };

    /******************** Searchable Dropdown *************************/

    this.renderSearchable = function() {
      var dropdown_input = this.querySelector("fn-dropdown-input");
      if (!dropdown_input) {
        return;
      }

      var base = this;
      var input = document.createElement("fn-input");
      var placeholder = dropdown_input.getAttribute('data-placeholder');
      var selected_item = this.querySelector("fn-dropdown-item[data-selected");

      if (placeholder) {
        input.setAttribute('data-placeholder', placeholder);
      }

      if (selected_item) {
        input.setAttribute('data-value', selected_item.innerText);
      }

      dropdown_input.appendChild(input);
      input.addEventListener('click', function(e) {
        e.stopPropagation();
        this.setAttribute('data-value', "");
        base.showDropdown();
      }, false);

      this.handleKeyNavigation(true);
    };

    this.showFilteredDropdownItems = function(value) {
      var items = this.querySelectorAll("fn-dropdown-item");
      var value = value.toLowerCase();

      for (var i = 0; i < items.length; i++) {
        if (items[i].innerText.toLowerCase().indexOf(value) > -1) {
          items[i].classList.remove('hidden');
        } else {
          items[i].classList.add('hidden');
        }
      }

      this.showDropdown();
    };
  };

  window.addEventListener("fn-ready", function() {
    Fnord.registerComponent("fn-dropdown", DropDownComponent);
  }, false);
</script>
