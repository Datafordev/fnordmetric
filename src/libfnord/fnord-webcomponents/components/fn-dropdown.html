<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<template id="fn-dropdown-base-tpl">
  <fn-dropdown-menu style="display:none">
  </fn-dropdown-menu>
</template>

<script type="text/javascript">
  var DropDownComponent = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate("fn-dropdown", "base");
      this.appendChild(tpl);
      var base = this;

      document.addEventListener('click', function() {
        base.hideDropdown();
      }, false);


      if (this.getAttribute('data-resolved') == 'resolved') {
        this.init();
      }
    };

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      if (attr == 'data-resolved' && new_val == 'resolved') {
        this.init();
      }
    };

    this.init = function() {
      /* options */
      if (this.querySelector('fn-dropdown-input')) {
      this.renderSearchable();
        return;
      }

      this.initHeaderItem();
    }

    // Checks if a header_elem exists and renders one if not
    this.initHeaderItem = function() {
      var base = this;
      var selected_item = this.querySelector("fn-dropdown-item[data-selected]");
      var header_elem = this.querySelector("fn-dropdown-header");

      if (!selected_item) {
        selected_item = this.querySelector("fn-dropdown-item");
        selected_item.setAttribute('data-selected', 'selected');
      }

      if (!header_elem) {
        header_elem = document.createElemment("fn-dropdown-header");
        this.insertBefore(header_elem, this.firstChild);
      }

      var onClick = function(e) {
        e.stopPropagation();
        base.showDropdown();
      };

      this.setHeaderValue();
      header_elem.addEventListener('click', onClick, false);
    };

    // Copies the selected items html to the header_elem
    this.setHeaderValue = function() {
      this.querySelector("fn-dropdown-header").innerHTML =
        this.querySelector("fn-dropdown-item[data-selected]").innerHTML;
    };

    this.hideDropdown = function() {
      this.querySelector("fn-dropdown-menu").removeAttribute('data-active');
    };

    this.showDropdown = function() {
      if (this.classList.contains("disabled")) {
        return;
      }

      var menu = this.querySelector("fn-dropdown-menu");
      menu.setAttribute('data-active', 'active');

      if (!this.eventListeners) {
        //set eventListeners only once
        this.setItemEventListeners();
      }

      this.handleKeyNavigation('show');
    };

    this.setItemEventListeners = function() {
      var base = this;
      var items = this.querySelectorAll("fn-dropdown-item");

      for (var i = 0; i < items.length; i++) {
        items[i].onclick = function() {
          base.onItemClick(this);
        }
      }

      this.eventListeners = true;
    };

    this.onItemClick = function(item) {
      var prev_item = this.querySelector("fn-dropdown-item[data-selected]");
      if (prev_item) {
        prev_item.removeAttribute('data-selected');
      }

      item.setAttribute("data-selected", 'selected');
      this.setHeaderValue();
      this.hideDropdown();
      this.fireClickEvent(item);
    };

    this.handleKeyNavigation = function(action) {
      this.addEventListener('keyup', function() {
        switch (e.keyCode) {
          case 38:
            base.keyNavigation('up');
            break;
          case 40:
            base.keyNavigation('down');
            break;
          case 13:
            base.keyNavigationSubmit();
            break;
          default:
            //base.search_item = this.value.toLowerCase();
            //base.showDropdown();
            break;
        }
      }
    }

    /* Key Navigation */
    this.keyNavigation = function(direction) {
      console.log("key nav");
      var hover_elem = this.querySelector("fn-dropdown-item.hover");
      var next_elem = null;

      if (hover_elem) {
        if (direction == 'down') {
          next_elem = hover_elem.nextSibling;
        } else {
          next_elem = hover_elem.previousSibling;
        }

        if (next_elem) {
          hover_elem.classList.remove("hover");
          next_elem.classList.add("hover");
          this.querySelector("ul").scrollTop = next_elem.offsetTop;
        }

      } else if (direction == 'down') {
        this.querySelector(".fn-dropdown-menu-item").classList.add("hover");
      }
    };


    this.renderSearchable = function() {
      var dropdown_input = this.querySelector("fn-dropdown-input");
      if (!dropdown_input) {
        return;
      }

      var input = document.createElement("fn-input");
      var placeholder = dropdown_input.getAttribute('data-placeholder');
      if (placeholder != null) {
        input.placeholder = placeholder;
      }

      dropdown_input.appendChild(input);
      this.setSearchInputValue();

      var base = this;

      input.addEventListener('click', function() {
        console.log("click");
        base.search_item = "";
      }, false);

      input.addEventListener('keyup', function(e) {
        switch (e.keyCode) {
          case 38:
            base.keyNavigation('up');
            break;
          case 40:
            base.keyNavigation('down');
            break;
          case 13:
            base.keyNavigationSubmit();
            break;
          default:
            base.search_item = this.value.toLowerCase();
            base.showDropdown();
            break;
        }
      }, false);
    };

    this.setSearchInputValue = function() {
      var input_header = this.querySelector("fn-dropdown-input fn-input-header");
      var active_item = this.querySelector("fn-dropdown-item[data-active]");

      if (active_item) {
        if (!input_header) {
          input_header = document.createElement("fn-input-header");
          this.querySelector("fn-dropdown-input").appendChild(input_header);
        }
        input_header.innerHTML = active_item.innerHTML;
      }
    };

    
    this.keyNavigationSubmit = function() {
      var shadow_elem = this.querySelector(".fn-dropdown-menu-item.hover");
      var index = shadow_elem.getAttribute('data-index');
      var active_item = this.querySelector("fn-dropdown-item[data-active]");

      if (shadow_elem && index) {
        var item = this.querySelector("fn-dropdown-item[data-index='" + index + "']");
        if (item) {
          if (active_item) {
            active_item.removeAttribute('data-active');
          }
          item.setAttribute('data-active', 'active');

          this.fireClickEvent(item);
          this.hideDropdown();
          this.setSearchInputValue();
        }
      }
    };

    this.fireClickEvent = function(item) {
      var ev = new CustomEvent("fn-dropdown-item-click", {
        detail : {'text' : item.innerText},
        bubbles: true,
        cancelable: true
      });
      item.dispatchEvent(ev);
    };
  };

  window.addEventListener("fn-ready", function() {
    Fnord.registerComponent("fn-dropdown", DropDownComponent);
  }, false);
</script>
