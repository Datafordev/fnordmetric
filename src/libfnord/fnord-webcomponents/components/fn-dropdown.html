<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<script type="text/javascript">
  var DropDownComponent = function() {
    this.createdCallback = function() {
      var base = this;

      //Remove?
      document.addEventListener('click', function() {
        base.hideDropdown();
      }, false);


      if (this.hasAttribute('data-resolved')) {
        this.initHeaderItem();
      }
    };

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      if (attr == 'data-resolved') {
        this.initHeaderItem();
      }
    };

    // Checks if a header_elem exists and renders one if not
    this.initHeaderItem = function() {
      if (this.querySelector("fn-dropdown-input")) {
        return this.renderSearchable();
      }

      var base = this;
      var selected_item = this.querySelector("fn-dropdown-item[data-selected]");
      var header_elem = this.querySelector("fn-dropdown-header");
      var preselection = this.getAttribute('data-preselected');

      if (!selected_item) {
        if (preselection) {
          selected_item = this.findItemByValue(preselection);
        }

        if (!selected_item) {
          selected_item = this.querySelector("fn-dropdown-item");
        }

        selected_item.setAttribute('data-selected', 'selected');
      }

      if (!header_elem) {
        header_elem = document.createElement("fn-dropdown-header");
        this.insertBefore(header_elem, this.firstChild);
      }

      var onClick = function(e) {
        e.stopPropagation();
        base.toggleDropdown();
      };

      this.setHeaderValue();
      header_elem.addEventListener('click', onClick, false);
    };

    // Copies the selected items html to the header_elem
    this.setHeaderValue = function() {
      this.querySelector("fn-dropdown-header").innerHTML =
        this.querySelector("fn-dropdown-item[data-selected]").innerHTML;
    };

    this.toggleDropdown = function() {
      if (this.querySelector("fn-dropdown-items").hasAttribute('data-active')) {
        this.hideDropdown();
      } else {
        this.showDropdown();
      }
    }

    this.hideDropdown = function() {
      var items = this.querySelector("fn-dropdown-items");
      if (items) {
        items.removeAttribute('data-active');
      }
    };

    this.showDropdown = function() {
      if (this.classList.contains("disabled")) {
        return;
      }

      var menu = this.querySelector("fn-dropdown-items");
      menu.setAttribute('data-active', 'active');

      if (!this.eventListeners) {
        //set eventListeners only once
        this.setItemEventListeners();
      }
    };

    this.findItemByValue = function(value) {
      return (this.querySelector(
        "fn-dropdown-item[data-value='" + value + "']"));
    }

    this.setItemEventListeners = function() {
      var base = this;
      var items = this.querySelectorAll("fn-dropdown-item");

      for (var i = 0; i < items.length; i++) {
        items[i].onclick = function() {
          base.onItemClick(this);
        }
      }

      this.eventListeners = true;
    };

    this.onItemClick = function(item) {
      var prev_item = this.querySelector("fn-dropdown-item[data-selected]");
      if (prev_item) {
        prev_item.removeAttribute('data-selected');
      }

      item.setAttribute("data-selected", 'selected');
      this.setHeaderValue();
      this.hideDropdown();
      this.fireClickEvent(item);
    };

    this.fireClickEvent = function(item) {
      var ev = new CustomEvent("fn-dropdown-item-click", {
        detail : {'text' : item.innerText},
        bubbles: true,
        cancelable: true
      });
      item.dispatchEvent(ev);
    };

    /******************** Searchable Dropdown *************************/

    this.renderSearchable = function() {
      var dropdown_input = this.querySelector("fn-dropdown-input");
      if (!dropdown_input) {
        return;
      }

      var base = this;
      var input = document.createElement("fn-input");
      var placeholder = dropdown_input.getAttribute('data-placeholder');
      var selected_item = this.querySelector("fn-dropdown-item[data-selected");

      if (placeholder) {
        input.setAttribute('data-placeholder', placeholder);
      }

      if (selected_item) {
        input.setAttribute('data-value', selected_item.innerHTML);
      }

      dropdown_input.appendChild(input);
      input.addEventListener('click', function(e) {
        e.stopPropagation();
        base.showDropdown();
        base.search_item = "";
      }, false);

      this.handleKeyNavigation(input);
    };

    this.showFilteredDropdownItems = function(value) {
      var items = this.querySelectorAll("fn-dropdown-item");
      var value = value.toLowerCase();

      for (var i = 0; i < items.length; i++) {
        if (items[i].innerText.toLowerCase().indexOf(value) > -1) {
          items[i].classList.remove('hidden');
        } else {
          items[i].classList.add('hidden');
        }
      }

      this.showDropdown();
    };

    this.handleKeyNavigation = function(elem) {
      var base = this;
      elem.addEventListener('keyup', function(e) {
        console.log(e.keyCode);
        e.preventDefault();
        switch (e.keyCode) {
          case 38:
            base.keyNavigation('up');
            break;
          case 40:
            base.keyNavigation('down');
            break;
          case 13:
            base.keyNavigationSubmit();
            break;
          default:
            base.showFilteredDropdownItems(this.getValue());
            break;
        }
      }, false);
    }

    // Key Navigation
    this.keyNavigation = function(direction) {
      var hover_elem = this.querySelector("fn-dropdown-item.hover");
      var next_elem = null;

      if (hover_elem) {
        if (direction == 'down') {
          next_elem = hover_elem.nextElementSibling;
        } else {
          next_elem = hover_elem.previousElementSibling;
        }

        if (next_elem) {
          hover_elem.classList.remove("hover");
          next_elem.classList.add("hover");
        }

      } else if (direction == 'down') {
        this.querySelector("fn-dropdown-item").classList.add("hover");
      }
    };

    this.keyNavigationSubmit = function() {
      var active_item = this.querySelector("fn-dropdown-item[data-active]");
      var selected_item = this.querySelector("fn-dropdown-item.hover");

      if (selected_item) {
          if (active_item) {
            active_item.removeAttribute('data-active');
          }

          selected_item.setAttribute('data-active', 'active');
          this.querySelector("fn-input").setAttribute(
            'data-value', selected_item.innerHTML);

          this.fireClickEvent(selected_item);
          this.hideDropdown();
      }
    };
  };

  window.addEventListener("fn-ready", function() {
    Fnord.registerComponent("fn-dropdown", DropDownComponent);
  }, false);
</script>
