<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<template id="fn-dropdown-base-tpl">
  <ul class="fn-dropdown-menu">
  </ul>
</template>

<script type="text/javascript">
  var DropDownComponent = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate("fn-dropdown", "base");
      this.appendChild(tpl);
      var base = this;

      /* options */
      if (this.hasAttribute('data-searchable')) {this.renderSearchInput();}


      this.attributeChangedCallback();
      this.observeHeaderItem();

      document.addEventListener('click', function() {
        base.hideDropdown();
      }, false);

    };

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      switch (attr) {
        case "data-active":
          this.renderDropdown();
          break;

        default:
          break;
      }
    };

    this.observeHeaderItem = function(prev_active_item) {
      var base = this;
      var header_elem = this.querySelector("fn-dropdown-item[data-active]");
      var default_header = this.querySelector("fn-dropdown-header");

      if (header_elem && default_header) {
        default_header.classList.add("hidden");
        prev_active_elem = default_header;
      } else if (!header_elem) {

        header_elem = default_header;

        if (!header_elem) {
          header_elem = this.querySelector("fn-dropdown-item");
          header_elem.setAttribute('data-active', 'active');
        }

      }

      header_elem.classList.add("header");

      var onClick = function(e) {
        e.stopPropagation();
        base.renderDropdown();
      };

      if (prev_active_item) {
        prev_active_item.removeEventListener('click', onClick, false);
      }

      header_elem.addEventListener('click', onClick, false);
    };


    this.hideDropdown = function() {
      this.querySelector(".fn-dropdown-menu").removeAttribute('data-active');
    };

    this.renderDropdown = function() {
      if (this.classList.contains("disabled")) {
        return;
      }
      var menu = this.querySelector(".fn-dropdown-menu");
      var items = this.querySelectorAll("fn-dropdown-item");

      menu.innerHTML = "";
      menu.setAttribute("data-active", "active");

      var label = this.querySelector("fn-dropdown-label");
      if (label) {this.renderListLabel(label.innerHTML, menu)};

      for (var i = 0; i < items.length; i++) {
        var list_elem = document.createElement("li");

        var onItemClick = (function(base, item) {
          return function(e) {
            e.stopPropagation();
            base.onItemClick(item, e.srcElement);
          };
        })(this, items[i]);

        list_elem.className = "fn-dropdown-menu-item";
        if (items[i].hasAttribute('data-active')) {
          list_elem.classList.add("active");
        }

        list_elem.innerHTML = items[i].innerHTML;
        menu.appendChild(list_elem);
        list_elem.addEventListener('click', onItemClick, false);
      }
    };



    this.renderListLabel = function(label, menu) {
      var list_elem = document.createElement("li");
      list_elem.className = "fn-dropdown-menu-label";
      list_elem.innerHTML = label;
      menu.appendChild(list_elem);
    };

    this.onItemClick = function(item, shadow) {
      var prev_active_item = this.querySelector("fn-dropdown-item[data-active]");
      if (prev_active_item) {
        prev_active_item.removeAttribute('data-active');
      }

      item.setAttribute("data-active", 'active');


      var ev = new CustomEvent("fn-dropdown-item-click", {
        bubbles: true,
        cancelable: true
      });
      this.dispatchEvent(ev);

      this.observeHeaderItem(prev_active_item);
      this.hideDropdown();
    };

    this.renderSearchInput = function() {
      this.search_item = "";
      var input = document.createElement("input");
      var placeholder = this.getAttribute('data-placeholder');
      if (placeholder != null) {
        input.placeholder = placeholder;
      }
      /*var dropdown_ui = this.shadowRoot.querySelector("#dropdown_ui");
      dropdown_ui.className = "input search";
      var header = this.shadowRoot.querySelector(".header");
      dropdown_ui.insertBefore(input, header);*/

      var base = this;

      input.addEventListener('click', function() {
        base.search_item = "";
      }, false);

      input.addEventListener('keyup', function(e) {
        switch (e.keyCode) {
          case 38:
            base.keyNavigationUp();
            break;
          case 40:
            base.keyNavigationDown();
            break;
          case 13:
            base.keyNavigationSubmit();
            break;
          default:
            base.search_item = this.value.toLowerCase();
            base.renderDropdown();
            break;
        }
      }, false);
    };



    /* Searchable Dropdown Key Navigation */
    this.keyNavigationUp = function() {
      var hover_elem = this.querySelector("fn-dropdown-item[hover]");
      if (hover_elem != null) {
        var index = parseInt(hover_elem.getAttribute('data-index'), 10) - 1;
        var elem = this.shadowRoot.querySelector("li[data-index='" + index + "']");
        if (elem != null) {
          hover_elem.removeAttribute("hover");
          elem.setAttribute("hover", "hover");
          this.shadowRoot.querySelector("ul").scrollTop = elem.offsetTop;
        }
      }
    };

    this.keyNavigationDown = function() {
      var hover_elem = this.shadowRoot.querySelector("li[hover]");
      if (hover_elem != null) {
        var index = parseInt(hover_elem.getAttribute('data-index'), 10) + 1;
        var elem = this.shadowRoot.querySelector("li[data-index='" + index + "']");
        if (elem != null) {
          hover_elem.removeAttribute("hover");
          elem.setAttribute("hover", "hover");
          this.shadowRoot.querySelector("ul").scrollTop = elem.offsetTop;
        }
      } else {
        var elem = this.shadowRoot.querySelector("li[data-index='0']");
        elem.setAttribute("hover", "hover");
      }
    };

    this.keyNavigationSubmit = function() {
      var shadow_elem = this.shadowRoot.querySelector("li[hover]");
      if (shadow_elem != null) {
        var value = shadow_elem.innerText;
        var item = this.querySelector(
          "fn-dropdown-item[data-value='" + value + "']");
        this.clickItem(item, shadow_elem);
      }
    };

  };

  window.addEventListener("fn-ready", function() {
    Fnord.registerComponent("fn-dropdown", DropDownComponent);
  }, false);
</script>
