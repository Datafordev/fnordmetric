<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<style type='text/css'>
  fn-date-time-selector {
    display: block;
  }
</style>
<template id='fn-date-time-selector-base-tpl'>
  <style type='text/css'>
    .wrapper {
      font-family: 'Helvetica Neue',Arial,Helvetica,sans-serif;
      font-size: 1rem;
      color: rgba(0,0,0,.8);
      height: 1rem;
      display: inline-block;
    }

    .wrapper * {
      float: left;
    }

    .wrapper .dropdown {
      margin: 0 5px;
    }

    .wrapper .header {
      margin: 0 5px;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      line-height: 1em;
      font-size: 0.875em;
      text-align: left;
    }

    .wrapper .header:hover,
    .wrapper .fa:hover {
      cursor: pointer;
    }

    .wrapper .header .text {
      font-weight: bold;
      display: inline-block;
    }

    .wrapper .header i.fa {
      margin: 0em 0.5em 0em 0.25em;
      vertical-align: top;
    }

    .widget {
      display: none;
    }

    .widget.active {
      display: block;
      position: fixed;
      background: #fff;
      box-shadow: 0 1px 4px 0 rgba(0,0,0,.15);
      border: 1px solid rgba(39,41,43,.15);
      border-radius: 0 0 .2857rem .2857rem;
      -webkit-transition: opacity .2s ease;
      transition: opacity .2s ease;
      z-index: 101;
      padding: 0.5em;
    }

    .widget fn-timeinput {
      float: none;
      display:block;
      margin-bottom: 0.5em;
    }

    .widget fn-calendar {
      float: none;
    }

    .fa {
      font-size: 0.9em !important;
      display: inline-block;
      line-height: 1;
      height: 1em;
      backface-visibility: hidden;
      font-weight: 400 !important;
      font-style: normal;
      text-align: center;
    }


  </style>

  <div class="wrapper">
    <i class="fa fa-chevron-left"></i>
    <div class="dropdown" id="range"></div>
    <div class="header">
      <div class="text" id="endtime_descr"></div>
      <i class="fa fa-caret-down"></i>
    </div>
    <div class="widget">
      <fn-timeinput></fn-timeinput>
      <fn-calendar data-style='small' data-selectable='past'></fn-calendar>
    </div>
    <i class="fa fa-chevron-right"></i>
  </div>
</template>
<script type='text/javascript'>
  var DateTimeSelector = function() {
    this.createdCallback = function() {
      var shadow = this.createShadowRoot();
      var tpl = Fnord.getTemplate('fn-date-time-selector', 'base');
      shadow.appendChild(tpl);

      if (this.getAttribute('data-resolved') == 'resolved') {
        this.init();
      }
    }

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      switch (attr) {
        case 'data-until':
          this.checkUntilAttr(false);
          this.updateUntil();
          break;
        case 'data-precision':
          this.checkPrecisionAttr();
          break;
        case 'data-range':
          this.checkRangeAttr();
          this.updateRange();
        default:
          break;
      }
    };

    this.checkUntilAttr = function() {
      var until = DateUtil.parseTimestamp(this.getAttribute('data-until'));
      this.setAttribute('data-until', until);

      this.timestamp = DateUtil.getTimestampObj(until);
    };

    this.checkRangeAttr = function() {
      var range = parseInt(this.getAttribute('data-range'), 10);
      if (isNaN(range)) {
        this.setAttribute('data-range', 900000);
      }
    };

    this.checkPrecisionAttr = function() {
      var precision = this.getAttribute('data-precision');
      var allowed_precisions = ["hour", "minute", "second"];

      if (allowed_precisions.indexOf(precision) == -1) {
        this.setAttribute('data-precision', 'minute');
      }
    };

    this.init = function() {
      this.checkRangeAttr();
      this.checkUntilAttr();
      this.checkPrecisionAttr();
      this.render();
      this.updateRange();
      this.observeActions();
    };

    this.updateRange = function() {
      this.shadowRoot.querySelector("fn-dropdown").setAttribute(
        'data-preselected', this.getAttribute('data-range'));
    };

    this.updateUntil = function() {
      var date = DateUtil.getDateObject(
        this.timestamp.date + this.timestamp.time, 
        this.getAttribute('data-precision'));

      var calendar = this.shadowRoot.querySelector("fn-calendar");

      //TODO timedescr from timestamp
      this.shadowRoot.getElementById("endtime_descr").innerHTML =
        DateUtil.getDateTimeDescr(date);

      calendar.setAttribute('data-selected', this.timestamp.date);
      calendar.setAttribute('data-timestamp', this.timestamp.date);
      this.shadowRoot.querySelector("fn-timeinput").setAttribute(
        'data-timestamp', this.timestamp.time);


    };

    this.render = function() {
      this.shadowRoot.getElementById('range').appendChild(
        this.querySelector("fn-dropdown"));

    };

    this.openWidget = function() {
      console.log("open widget");
      var widget = this.shadowRoot.querySelector(".widget");
      var pos = this.shadowRoot.querySelector(".wrapper").getBoundingClientRect();

      if (widget.style.marginTop.length == 0) {
        widget.style.marginTop = pos.height + 5 + "px";
      }

      widget.setAttribute('data-selected', this.getAttribute('data-until'));
      widget.classList.add("active");

      //center widget relative to wrapper_elem
      widget.style.marginLeft = ((pos.width - widget.offsetWidth) / 2) + "px";
    }

    this.closeWidget = function(timestamp) {
      this.shadowRoot.querySelector(".widget").classList.remove("active");
      if (timestamp) {
        this.setAttribute('data-until', timestamp);
        this.fireEvent(
            'fn-date-time-selector-until', {"until" : timestamp})
      }
    }

    this.observeActions = function() {
      var base = this;
      var widget = this.shadowRoot.querySelector(".widget");
      var timeinput = widget.querySelector("fn-timeinput");
      var calendar = widget.querySelector("fn-calendar");

      this.shadowRoot.querySelector(".fa-chevron-left").onclick = function() {
        var until =
          parseInt(base.getAttribute('data-until'), 10) -
          parseInt(base.getAttribute('data-range'), 10);
        base.setAttribute('data-until', until);
        base.fireEvent('fn-date-time-selector-until', {"until" :until});
      };

      this.shadowRoot.querySelector(".fa-chevron-right").onclick = function() {
        var until =
          parseInt(base.getAttribute('data-until'), 10) +
          parseInt(base.getAttribute('data-range'), 10);
        base.setAttribute('data-until', until);
        base.fireEvent('fn-date-time-selector-until', {"until" :until});
      };

      this.shadowRoot.querySelector("fn-dropdown").addEventListener(
        'fn-dropdown-item-click', function(e) {
          var range = e.srcElement.getAttribute('data-value');
          base.setAttribute(
            'data-range', range);
          base.fireEvent('fn-date-time-selector-range', {"range": range});
        },
      false);

      this.shadowRoot.querySelector(".header").onclick = function(e) {
        e.stopPropagation();
        if (widget.classList.contains("active")) {
          base.closeWidget();
        } else {
          base.openWidget();
        }
      };

      widget.onclick = function(e) {
        e.stopPropagation();
      };

      calendar.addEventListener('fn-calendar-select',
        function(e) {
          base.closeWidget(e.detail.timestamp + timeinput.getValues().timestamp);
        },
      false);

      timeinput.addEventListener('fn-timeinput-submit',
        function(e) {
          base.closeWidget(
            e.detail.timestamp +
            parseInt(calendar.getAttribute('data-selected'), 10));
        },
      false);

    };

    this.fireEvent = function(name, detail) {
      var timeEvent = new CustomEvent(
        name, {
          'detail': detail,
          bubbles: true,
          cancealable: true
      });

      this.dispatchEvent(timeEvent);
    }

  };

  window.addEventListener('fn-ready', function() {
    Fnord.registerComponent('fn-date-time-selector', DateTimeSelector);
  }, false);
</script>
