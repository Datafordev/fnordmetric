<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<template id="fn-metric-explorer-preview-base-tpl">
  <style type='text/css'>
    .navigation {
      padding: 0 15px;
    }
    .navigation fn-button {
      margin: 5px 8px 0 0;
    }

    .navigation .item {
      vertical-align: middle;
      margin-left: 0.8%;
      float: left;
    }

    .navigation .item:first-child {
      margin-left: 0;
    }

    fn-loader[name='result_pane'] fn-message {
      display:none;
    }

    fn-loader[name='result_pane'] fn-message.active {
      display: block;
      margin: auto;
      margin-top: 25px;
    }

    .result_pane {
      padding: 10px;
      background: #fff;
      display: none;
      text-align: cente;
    }

    .result_pane.active {
      display: block;
    }


    .result_pane fn-table {
      display:block;
    }


    #raw.result_pane {
      padding: 10px 10px 20px;
    }

    fn-controls /deep/ .controls_inner {
      border-top: 1px solid #bbb;
    }

    fn-controls[type='secondary'] /deep/ .controls_inner {
      border-bottom: none !important;
    }

    fn-datepicker /deep/ #datepicker_widget {
      left: 170px;
    }

    fn-modal-content code {
      word-wrap: break-word;
    }

    fn-modal[name='select_metric'] {
      width: 25%;
      left: 65%;
    }

    fn-modal[name='select_metric'] fn-table {
      width: 100%;
    }
  </style>
  <fn-loader name='metric_explorer_preview'>
    <div class="navigation">
      <div class="item left">
        <span class="text">Display: </span>
        <fn-dropdown data-resolved class="inline small" name="format">
          <fn-dropdown-items>
            <fn-dropdown-item data-value='svg'>Chart</fn-dropdown-item>
            <fn-dropdown-item data-value='csv'>Raw</fn-dropdown-item>
          </fn-dropdown-items>
        </fn-dropdown>
      </div>

      <fn-button id="embed_btn" class="item left" data-size='tiny' style="display:none;">
        <i class='fa fa-share'></i>Embed
      </fn-button>
      <fn-button id="auto_refresh" class="item left" data-toggle data-size='tiny' style="display:none;">
        <i class='fa fa-refresh'></i>Auto Refresh
      </fn-button>

      <div class="item" style="height: 36px; line-height: 36px; float: right;">
        <fn-date-time-selector data-selectable='past'>
          <fn-date-time-selector-icon class='left'></fn-date-time-selector-icon>
          <fn-dropdown id='timerange' class="inline">
            <fn-dropdown-items>
              <fn-dropdown-item data-value=300>5 minutes</fn-dropdown-item>
              <fn-dropdown-item data-value=900>15 minutes</fn-dropdown-item>
              <fn-dropdown-item data-value=1800>30 minutes</fn-dropdown-item>
              <fn-dropdown-item data-value=3600>1 hour</fn-dropdown-item>
              <fn-dropdown-item data-value=14400>4 hours</fn-dropdown-item>
              <fn-dropdown-item data-value=43200>12 hours</fn-dropdown-item>
              <fn-dropdown-item data-value=86400>1 day</fn-dropdown-item>
            </fn-dropdown-items>
          </fn-dropdown>
          <fn-date-time-selector-icon class='right'></fn-date-time-selector-icon>
        </fn-date-time-selector>
      </div>
    </div>

    <div class="metric-controls">
      <fn-metric-control data-index="0"></fn-metric-control>
    </div>

    <fn-loader name='result_pane' data-loading data-resolved="data-resolved" data-transparent>
      <fn-message>
      </fn-message>
      <div class="result_pane active" data-format="svg">
      </div>
      <div class="result_pane" data-format="csv">
        <fn-table data-page='0' data-per-page='25'>
          <fn-table-column>Metric</fn-table-column>
          <fn-table-column>Time</fn-table-column>
          <fn-table-column>Value</fn-table-column>
          <table></table>
        </fn-table>
        <fn-pager data-for data-first-item='1' data-circling data-per-page='25'></fn-pager>
      </div>
    </fn-loader>

    <fn-modal-dimmer>
      <fn-modal id="embed">
        <fn-modal-close-icon></fn-modal-close-icon>
        <fn-modal-header>Embed</fn-modal-header>
        <fn-modal-content>
          <div class="header">Copy this into your HTML Page</div>
          <code>
            &lt;iframe<br />&nbsp;&nbsp;&nbsp;&nbsp;width="800"<br />
            &nbsp;&nbsp;&nbsp;&nbsp;height="400"<br />
            &nbsp;&nbsp;&nbsp;&nbsp;frameBorder="0"<br />
            &nbsp;&nbsp;&nbsp;&nbsp;src="<span id="src"></span>"
            &gt;<br />&lt;/iframe&gt;
          </code>
        </fn-modal-content>
      </fn-modal>
    </fn-modal-dimmer>
  </fn-loader>

  <fn-modal-dimmer>
    <fn-modal name='select_metric'>
      <fn-modal-close-icon></fn-modal-close-icon>
      <fn-modal-header>Select Metric</fn-modal-header>
      <fn-modal-content>
        <fn-table data-clickable></fn-table>
      </fn-modal-content>
    </fn-modal>
  </fn-modal-dimmer>

  <fn-tooltip data-pointer="right" id='ttp_endtime'>
    Please select a date in the past
  </fn-tooltip>
  <fn-tooltip data-pointer='right' id="ttp_embed">Embed</fn-tooltip>
  <fn-tooltip data-pointer='right' id="ttp_refresh">Auto Refresh</fn-tooltip>
</template>

<script type='text/javascript'>
  var MetricExplorerPreview = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate("fn-metric-explorer-preview", "base");
      this.appendChild(tpl);

      if (this.getAttribute('data-url') != null) {
        this.init()
      }
    };

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      switch (attr) {
        case 'data-url' :
          this.init();
          break;
        case 'data-format' :
          this.updateGenericParams({'format' :new_val});
          break;
        default:
          break;
      }
    };

    this.init = function() {
      var base = this;
      this.params = Fnord.parseMetricQueryUrl(this.getAttribute("data-url"));
      this.handleGenericControls();

      //init mainMetric
      this.initMetricControl(
        this.querySelector("fn-metric-control"), this.params.metric0.name, 0);

      //init subMetrics
      for (var i = 1; i < parseInt(this.params.metrics, 10); i++) {
        this.initMetricControl(
          this.addMetricControl(i, false), this.params["metric" + i]["name"], i);
      }

      this.classList.add("resizable");

      document.addEventListener("DOMContentLoaded", function() {
        base.onResize();
        base.DOMLoaded = true;
      }, false);
    };

    this.update = function(format) {
      var urls = this.buildQueryUrl(format);

      Fnord.setUrlHash("#metric?" + urls.url);
      this.updateData(urls.query_url);
    };

    this.buildQueryUrl = function(format) {
      var url = "";
      var query_url = "";

      for (var i = 0; i < parseInt(this.params.metrics, 10); i++) {
        var metric_params = this.params["metric" + i];

        for (var key in metric_params) {
          if (!metric_params[key] ||
              metric_params[key].length == 0 ||
              metric_params[key] == "undefined") {continue;}

          if (key == "name") {
            //name is first param
            url += (i == 0)? "" : "&";
            url += "metric=" + encodeURIComponent(metric_params[key]);
          } else if (key == "aggr_fn") {
            //value is automatically returned if aggr_fn isn't set
            if (metric_params[key] != "value") {
              url += "&" + key + "=" + metric_params[key];
            }
          } else if (Fnord.isMetricParam(key)) {
            //all other metric params
            url += "&" + key + "=" + metric_params[key];
          }
        }
      }

      url +=
        "&from=" + this.getGenericParamOrDefault("from") +
        "&until=" + this.getGenericParamOrDefault("until") +
        "&format=" + this.getGenericParamOrDefault("format");

      //params that can't be set by controls aren't visible in url
      query_url = url;
      query_url +=
        "&logarithmic=" + this.getGenericParamOrDefault("logarithmic") +
        "&inverted=" + this.getGenericParamOrDefault("inverted") +
        "&min=" + this.getGenericParamOrDefault("min") +
        "&height=" + this.getGenericParamOrDefault("height") +
        "&width=" + this.getGenericParamOrDefault("width") +
        "&grid=both" +
        "&axis_right=true" +
        "&legend=toprightinside";

      return {'url' :url, 'query_url' : query_url};
    };

    this.updateData = function(query_url) {
      var base = this;
      var url = "/metrics/timeseries?" + query_url;
      var format = this.getGenericParamOrDefault('format');

      Fnord.httpGet(url, function(r) {
        if (r.status == 200) {
          if (format == "svg") {
            return base.renderChart(r.response);
          }

          if (r.response.length > 0) {
            return base.renderCsvAsTable(r.response);
          }

          //no data points don't cause an error if format is csv
          var resp = {
            'status': r.status,
            'statusText': r.statusText,
            'response': "Empty Table"
          }
          return base.renderError(resp);

        }

        return base.renderError(r);
      });
    };

    this.onRefresh = function() {
      var end_time = Date.now();
      var time_range = this.getGenericParamOrDefault('time_range');
      var start_time = end_time - time_range;
      this.updateGenericParams({
        'until' : until,
        'from' : from});
    };

    this.hideActiveResult = function() {
      var active_elem = this.querySelector("fn-loader[name='result_pane'] .active")
      if (active_elem) {
        active_elem.classList.remove("active");
      }
    }

    this.renderChart = function(resp) {
      var pane = this.querySelector(".result_pane[data-format='svg']");
      this.hideActiveResult();
      pane.classList.add("active");
      pane.innerHTML = "";
      pane.innerHTML = resp;
      this.querySelector("fn-loader[name='result_pane']").removeAttribute("data-loading");
    };

    this.renderCsvAsTable = function(csv) {
      var base = this;
      var pane = this.querySelector(".result_pane[data-format='csv']");
      var fn_table = pane.querySelector("fn-table");
      var table = fn_table.querySelector("table");
      var pager = pane.querySelector("fn-pager");
      var data_points = csv.split(/\n/);
      var row_count = 0;

      this.hideActiveResult();

      table.innerHTML = "";
      pane.classList.add("active");

      data_points.forEach(function(point) {
        if (point.length > 0) {
          var entries = point.split(";");
          var tr_elem = document.createElement("tr");
          entries.forEach(function(entry) {
            var td_elem = document.createElement("td");
            td_elem.innerHTML = entry;
            tr_elem.appendChild(td_elem);
          });

          table.appendChild(tr_elem);
          row_count++;
        }
      });

      pager.setAttribute('data-last-item', row_count);
      pager.forElement(fn_table);
      fn_table.renderTable();

      this.querySelector("fn-loader[name='result_pane']").removeAttribute("data-loading");
    };


    this.renderError = function(response) {
      var loader = this.querySelector("fn-loader[name='result_pane']");
      var msg_elem = loader.querySelector("fn-message");
      var header_elem = document.createElement("fn-message-header");
      var text_elem = document.createElement("fn-message-text");

      header_elem.innerHTML = response.statusText;
      text_elem.innerHTML =
        "statusCode: " + response.status + " " + response.response;
      msg_elem.innerHTML = "";
      msg_elem.appendChild(header_elem);
      msg_elem.appendChild(text_elem);

      this.hideActiveResult();
      msg_elem.classList.add("active");
      loader.removeAttribute("data-loading");
    };

/*********************** Metric Controls *****************************/
    this.metricParamChanged = function(params, key) {
      this.params["metric" + params.index] = params;
      this.update();
    };

    this.getMetricUrlParamOrDefault = function(key, index) {
      var defaults = {
        "aggr_fn": "sum",
        "aggr_window": "5",
        "aggr_step": "10",
        "scale" : "0.8",
        "group_by" : ""
      }

      if (this.params["metric" + index] && this.params["metric" + index][key]) {
        return this.params["metric" + index][key];
      }

      return defaults[key] ;
    };

    this.setMetricColumns = function(metric_control) {
      var url = "/metrics/list?filter=" + encodeURIComponent(metric_control.params.name);
      metric_control.params.group_by = this.getMetricUrlParamOrDefault(
        "group_by", metric_control.params.index);

      Fnord.httpGet(url, function(r) {
        if (r.status == 200) {
          var json = JSON.parse(r.response);
          json.metrics.map(function(m) {
            metric_control.params.columns = m.labels.join(",");
          });
          metric_control.columnsReloaded();
        }
      });
    };

    this.initMetricControl = function(metric, name, index) {
      var base = this;

      if (!index) {
        index = metric.getAttribute('data-index');
      }

      var aggr_fn = this.getMetricUrlParamOrDefault("aggr_fn", index);

      var metric_params = {
        "name": name,
        "aggr_fn": aggr_fn,
        "scale": this.getMetricUrlParamOrDefault("scale", index),
        "index" : index
      }

      if (aggr_fn != "value") {
        metric_params.aggr_window =
          this.getMetricUrlParamOrDefault("aggr_window", index);
        metric_params.aggr_step =
          this.getMetricUrlParamOrDefault("aggr_step", index);
      }


      if (this.params["metric" + index] == undefined) {
        this.params["metric" + index] = metric_params;
        this.params.metrics += 1;
        this.update();
      }

      metric.params = metric_params;
      metric.setAttribute('data-index', index);
      metric.setAttribute('data-state', 'initialised');

      if (metric.params.name) {
        //reload metric columns
        metric_params.columns = this.setMetricColumns(metric);
      }

      // handle events
      metric.addEventListener(
        "fn-metric-control-attr-changed", function(e) {
          base.metricParamChanged(this.params, e.detail.key);
        },
      false);

      if (index > 0) {
        metric.addEventListener('fn-metric-control-remove-metric', function() {
          base.removeMetricControl(this.getAttribute('data-index'));
        }, false);
      } else {
        metric.addEventListener('fn-metric-control-add-metric', function() {
          base.renderSelectMetricModal();
        }, false);
      }
    };

    this.addMetricControl = function(index) {
      var base = this;
      var controls = this.querySelectorAll("fn-metric-control");
      var new_control = document.createElement("fn-metric-control");
      var index = index;

      if (!index && controls) {
        index = parseInt(
          controls[controls.length - 1].getAttribute('data-index'), 10) + 1;
      }

      new_control.setAttribute('data-state', 'select-metric');
      new_control.setAttribute('data-index', index);

      this.querySelector(".metric-controls").appendChild(new_control);

      //only call onResize if DOMContent has already been loaded
      if (this.DOMLoaded) {
        this.onResize();
      }

      return new_control;
    };

    this.removeMetricControl = function(index) {
      var metric_control =
        this.querySelector("fn-metric-control[data-index='" + index + "']");

      metric_control.parentNode.removeChild(metric_control);
      this.onResize();

      if (this.params["metric" + index]) {
        //metric has been initialised
        delete this.params["metric" + index];
        this.params.metrics = this.params.metrics - 1;
      }

      this.update();
    };

    this.renderSelectMetricModal = function() {
      var base = this;
      var modal = this.querySelector("fn-modal[name='select_metric']");
      var table = modal.querySelector("fn-table");
      table.querySelector("table").innerHTML = "";

      Fnord.httpGet('/metrics/list', function(r) {
        if (r.status == 200) {
          var metrics = JSON.parse(r.response).metrics;
          metrics.forEach(function(metric) {
            var tr_elem = document.createElement("tr");
            tr_elem.setAttribute('metric-key', metric.key);
            tr_elem.innerHTML = "<td>" + metric.key + "</td>";
            table.appendRow(tr_elem);
          });
        }
        modal.show();
      });

      if (!table.rowClickListener) {
        table.rowClickListener = true;

        table.addEventListener('fn-table-row-click', function(e) {
          var key = e.srcElement.getAttribute('metric-key');
          var control = base.addMetricControl(null, true);
          base.initMetricControl(control, key);
          modal.close();
        }, false);
      }
    };

/************************* Generic Controls **************************/
    this.getGenericParamOrDefault = function(key) {
      var defaults = {
        until : Math.round(Date.now() / 1000),
        /* 5 minutes  */
        time_range : 3600,
        /* 10, 5 seconds */
        aggr_step : 10,
        aggr_window : 5,
        logarithmic : false,
        inverted: false,
        min: 0,
        format: 'svg'
      }

      if (key == "time_range") {
        var end_time = parseInt(this.getGenericParamOrDefault("until"), 10);
        var start_time = parseInt(this.params['from'], 10);
        if (!isNaN(start_time)) {
          return end_time - start_time;
        } else {
          return defaults['time_range'];
        }
      }

      var value = (this.params[key])?
        this.params[key] : defaults[key];

      return value;
    };

    this.updateGenericParams = function(new_params) {
      for (var key in new_params) {
        if (new_params[key] != undefined) {
          this.params[key] = new_params[key].toString();
        }
      }

      this.update();
    };

    this.onResize= function() {
      var padding = 20;
      var result_loader = this.querySelector("fn-loader[name='result_pane']");
      var height =
        window.innerHeight - result_loader.getBoundingClientRect().top - padding;
      var width = window.innerWidth - padding;

      this.updateGenericParams({'height': height, 'width' : width});
    };

    /* handles controls for generic params */
    this.handleGenericControls = function() {
      var base = this;
      /* init */
      var embed_btn = this.querySelector("#embed_btn");
      var autorefresh_btn = this.querySelector("#auto_refresh");
      var modal = this.querySelector("fn-modal");
      var format_dropdown = this.querySelector("fn-dropdown[name='format']");

      var selector = this.querySelector("fn-date-time-selector");
      var range = parseInt(this.getGenericParamOrDefault("time_range"), 10);
      var until = parseInt(this.getGenericParamOrDefault("until"), 10);

      var interval_id;

      selector.setAttribute('data-until', until);
      selector.setAttribute('data-range', range);
      selector.setAttribute('data-resolved', 'resolved');

      format_dropdown.setAttribute('data-preselected', this.getGenericParamOrDefault('format'));
      format_dropdown.setAttribute('data-resolved', 'resolved');

      this.querySelector("fn-tooltip#ttp_embed").init(embed_btn);
      this.querySelector("fn-tooltip#ttp_refresh").init(autorefresh_btn);

      /* handle Events */
      //date
      selector.addEventListener('fn-date-time-selector-until', function(e) {
        var until = Math.round(parseInt(e.detail.until, 10) / 1000);
        var from = until - base.getGenericParamOrDefault("time_range");
        base.updateGenericParams({'until': until, 'from' : from});
      }, false);

      selector.addEventListener('fn-date-time-selector-range', function(e) {
        var until = base.getGenericParamOrDefault("until");
        var from = until - parseInt(e.detail.range, 10)
        base.updateGenericParams({'from' : from});
      }, false);

      //format
      format_dropdown.addEventListener('fn-dropdown-item-click', function(e) {
        base.setAttribute("data-format", e.srcElement.getAttribute('data-value'));
      }, false);

      autorefresh_btn.addEventListener('fn-button-click', function() {
        if (this.getAttribute('data-state') == "active") {
          window.clearInterval(interval_id);
          this.removeAttribute('data-state');
        } else {
          interval_id = window.setInterval(function() {base.onRefresh(); }, 30000);
          this.setAttribute('data-state', 'active');
        }
      }, false);

      embed_btn.addEventListener('fn-button-click', function() {
        modal.querySelector("span").innerHTML =
          "/metrics/" + base.buildQueryUrl(base.getAttribute('data-format'));
        modal.show();
      }, false);
    };
  };

  window.addEventListener('fn-ready', function() {
    Fnord.registerComponent('fn-metric-explorer-preview', MetricExplorerPreview);
  }, false);
</script>
