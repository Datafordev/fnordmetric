<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<style type="text/css">
  
</style>

<template id="fnordmetric-query-editor-base-tpl">
  <fn-loader data-loading data-loader-type="loader3">
    <fn-splitpane id="splitpane" data-split="vertical" left-width-relative='30'>
    </fn-splitpane>
  </fn-loader>
</template>

<script type="text/javascript">
  var FnordMetricQueryEditorComponent = function() {

    this.createdCallback = function() {
      var tpl = Fnord.getTemplate("fnordmetric-query-editor", "base");
      this.appendChild(tpl);

      var loader = this.querySelector("fn-loader");
      loader.removeAttribute("data-loading");

      this.renderNavBar();
      this.renderCodeEditor();

      if (this.getAttribute('data-url') != null) {
        var params =
          FnordMetric.util.parseQueryString(this.getAttribute('data-url'));
        var query = params.query_params.innerViewValue;
        splitpane.shadowRoot.querySelector("fn-codeeditor").setValue(query);
        this.runQuery(query);
      }


      this.attributeChangedCallback();
    };

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      if (attr == "data-url") {
        if (old_val == null) {
          var params =
            FnordMetric.util.parseQueryString(new_val);
          var query = params.query_params.innerViewValue;
          var splitpane = this.querySelector("fn-splitpane");
          splitpane.shadowRoot.querySelector("fn-codeeditor").setValue(query);
          console.log(splitpane.shadowRoot.querySelector("fn-codeeditor"))
          this.runQuery(query);

        }

      }
    }

    this.updateUrl = function() {
      var code_editor = splitpane.shadowRoot.querySelector("fn-codeeditor");
      var query = code_editor.getValue();
      this.setAttribute('data-url', encodeURIComponent(query));
      var params = {
        innerView : "sql_editor",
        innerViewValue : query};
      FnordMetric.util.setURLQueryString("query", params, true);
      this.runQuery(query);
    }

    this.runQuery = function(query) {
      var base = this;

      Fnord.httpPost("/query", query, function(r, duration) {
        if (r.status == 200 && r.statusText == "OK") {
          var res = JSON.parse(r.response, duration);
          base.renderResult(res);
          //FnordMetric.extendCharts();
        } else {
          /* server error */
          base.renderError(
            "Sorry, FnordMetric Server encountered an error. " + "<br>" + 
            "If you believe this is a bug in FnordMetric Server "+
            "please report an issue at github.com/.../issues.");
        }
      });

    };

    this.renderResult = function(response, duration) {
      var splitpane = this.querySelector("fn-splitpane");
      var right_pane = splitpane.shadowRoot.querySelector("fn-splitpane-right");
      right_pane.innerHTML = "";
      var loader = document.createElement("fn-loader");
      loader.setAttribute("data-loading", "data-loading");
      right_pane.appendChild(loader);

      if (response.status == "error") {
        this.renderError(response.error);
      } else {
        if (response.charts != undefined) {
          this.renderChart(response.charts, loader);
        }
        if (response.tables != undefined) {
          this.renderTable(response.tables, loader);
        }
      }
      //renderExecutionInfo
    };

    this.renderError = function(error_message) {
      var right_pane = splitpane.shadowRoot.querySelector("fn-splitpane-right");
      right_pane.innerHTML =
        "<div class='error_box'>" + error_message + "</div>";
    };

    this.renderChart = function(charts, loader) {
      var result_card = document.createElement("div");
      result_card.className = "result_card";

      var controls = document.createElement("div");
      controls.className = "metric_preview_secondary_controls";
      controls.innerHTML = "<a style='float: left;'>Result Chart</a>";

      var embed_btn = document.createElement("i");
      embed_btn.className = "fa fa-share";
      embed_btn.innerHTML = "Embed";

      controls.appendChild(embed_btn);
      result_card.appendChild(controls);

      var svg = document.createElement("div");
      svg.className = "svg";
      svg.innerHTML = charts[0].svg;
      result_card.appendChild(svg);

      loader.appendChild(result_card);
    }

    this.renderTable = function(tables, loader) {
      var result_card = document.createElement("div");
      result_card.className = "result_card";

      var controls = document.createElement("div");
      controls.className = "metric_preview_secondary_controls";
      controls.innerHTML = "<a style='float: left;'>Result Table</a>";

      var table_elem = document.createElement("fn-table");
      table_elem.setAttribute("data-per-page", 25);

      tables.map(function(t) {
        t.columns.map(function(c) {
          var column_elem = document.createElement("fn-table-column");
          column_elem.innerHTML = c;
          table_elem.appendChild(column_elem);
        });

        t.rows.map(function(r) {
          var row_elem = document.createElement("tr");
          r.map(function(cell) {
            row_elem.innerHTML += "<td>" + cell + "</td>";
          });

          //table_elem.appendRow(row_elem); soo slow
          table_elem.appendChild(row_elem);
        });
        table_elem.renderTable();
      });

      loader.removeAttribute("data-loading");
      result_card.appendChild(controls);
      result_card.appendChild(table_elem);
      loader.appendChild(result_card);
    }

    this.renderCodeEditor = function() {
      var splitpane = this.querySelector("fn-splitpane");
      var left_pane = splitpane.shadowRoot.querySelector("fn-splitpane-left");

      var code_editor = document.createElement("fn-codeeditor");
      left_pane.appendChild(code_editor);

      var base = this;

      code_editor.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.keyCode == 13) {
          e.preventDefault();
          base.updateUrl();
        }
      }, false);
    }

    this.renderNavBar = function() {
      var splitpane = this.querySelector("fn-splitpane");
      var left_pane = splitpane.shadowRoot.querySelector("fn-splitpane-left");
      var base = this;
      var app = document.querySelector("fnordmetric-app");

      /* render buttons */
      button_bar = document.createElement("div");
      button_bar.className = "navbar";

      var editor_picker = document.createElement("div");
      editor_picker.className = "editor_type_picker";
      editor_picker.innerHTML = 
        "<i class='fa fa-database'></i> SQL Editor";
      button_bar.appendChild(editor_picker);

      var split_btn = document.createElement("i");
      split_btn.className = "fa fa-columns icobtn";
      button_bar.appendChild(split_btn);

      var refresh_btn = document.createElement("i");
      refresh_btn.className = "fa fa-refresh icobtn";
      button_bar.appendChild(refresh_btn);

      var exec_btn = document.createElement("span");
      exec_btn.className = "run_query_btn";
      exec_btn.innerHTML = "<i class='fa fa-bolt'></i> Run Query";
      button_bar.appendChild(exec_btn);

      left_pane.appendChild(button_bar);

      exec_btn.onclick = function() {
        base.updateUrl();
      }

      split_btn.onclick = function(e) {
        console.log(splitpane.getAttribute("data-split"));
        if (splitpane.getAttribute("data-split") == "vertical") {
          splitpane.setAttribute("data-split", "horizontal");
        } else {
          splitpane.setAttribute("data-split", "vertical");
        }
      }

      refresh_btn.onclick = function() {
        app.openUrl(base.getAttribute('data-url'));
      }

    }



  };

  window.addEventListener("fn-ready", function() {
    Fnord.registerComponent(
        "fnordmetric-query-editor",
        FnordMetricQueryEditorComponent);
  }, false);
</script>



