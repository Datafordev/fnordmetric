<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<template id="fnordmetric-metric-preview-base-tpl">
  <fn-loader>
    <h1 class="page_header"><i>Metric</i> &rsaquo; <span></span> </h1>
    <fn-controls type='primary'>
      <fn-controls-section data-position='left'>
        <div class='group aggregation_type'>
          <b>Rollup</b>
          <fn-dropdown id='rollup'>
          </fn-dropdown>
        </div>
        <div class='group aggregation_time_window'>
          <b>Time Window / Step</b>
          <fn-dropdown id='time_window'>
          </fn-dropdown>
          <fn-dropdown id='time_step'>
          </fn-dropdown>
        </div>
      </fn-controls-section>
      <fn-controls-section data-position='right'>
        <div class='group timerange'>
          <b>Show The Last...</b>
          <fn-dropdown id='timerange'>
          </fn-dropdown>
        </div>
        <div class='group date'>
          <b>End Time</b>
          <fn-datepicker time-select='input'>
          </fn-datepicker>
        </div>
      </fn-controls-section>
    </fn-controls>
    <fn-controls type='secondary'>
      <fn-controls-section data-position='left'>
        <fn-button>
          <i class='fa fa-database'></i>
          SQL Editor
        </fn-button>
        <fn-button>
          <i class='fa fa-share'></i>
          Embed
        </fn-button>
      </fn-controls-section>
      <fn-controls-section data-position='right'>
        <fn-daterangepicker>
        </fn-daterangepicker>
      <fn-controls-section>
    </fn-controls>
  </fn-loader>
</template>

<script type="text/javascript">
  var FnordMetricMetricPreviewComponent = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate("fnordmetric-metric-preview", "base");
      this.appendChild(tpl);

      var controls = this.querySelector("fn-controls");
      var header = this.querySelector(".page_header");

      if (this.getAttribute('data-url') != null) {
        var params = FnordMetric.util.parseQueryString(
          this.getAttribute("data-url"));
        header.querySelector("span").innerHTML = params.query_params.innerViewValue;

        var query =
          FnordMetric.util.generateSQLQueryFromParams(params.query_params);
        //this.runQuery(query);

        this.initControls();
        this.handleAggregationDisplay();
      }

      this.attributeChangedCallback();
    };

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      if (attr == "data-url") {
        var header = this.querySelector(".page_header");
        var params = FnordMetric.util.parseQueryString(
          this.getAttribute("data-url"));

        header.querySelector("span").innerHTML = params.query_params.innerViewValue;

        var query =
          FnordMetric.util.generateSQLQueryFromParams(params.query_params);

        //this.runQuery(query);


        if (old_val == null) {
          this.initControls();
          this.handleAggregationDisplay();
        }
      }
    }

    this.runQuery = function(query) {
      var queryurl = "/query?height=400&width=" + (window.innerWidth - 40);
      Fnord.httpPost(queryurl, query, function(r) {
        if (r.status == 200) {
          var json = JSON.parse(r.response);
          console.log(json);
          if (json.charts != undefined) {
            //renderChart(json.charts[0]);
          } else {
            //renderError(json.error);
          }
          if (json.tables != undefined) {
            //renderTable(json.tables[0]);
          }
        }
      });
    };

    this.getQueryParamOrDefaultValue = function(key) {
      var defaults = {
        view : "value",
        columns: "",
        end_time : Date.now(),
        /* 5 minutes  */
        //time_to_end
        time_range : 300000,
        /* 1 second */
        t_step : 10000,
        t_window : 5000,
        /*how to set by value */
        by: ""
      }

      var params = FnordMetric.util.parseQueryString(
          this.getAttribute("data-url"));


      var value = (params.query_params[key] == undefined)?
        defaults[key] : params.query_params[key];


      return value;
    };

    this.updateUrlParams = function(key, value) {
      if (value != undefined) {
        var params = FnordMetric.util.parseQueryString(
          this.getAttribute("data-url"));

        params.query_params[key] = value.toString();
        var path =FnordMetric.util.setURLQueryString(
          "metric", params.query_params, false, true);
        this.setAttribute("data-url", path);

      }
    };

    this.updateDateTimeElems = function() {
      var params = FnordMetric.util.parseQueryString(
          this.getAttribute("data-url"));
      var datepicker = this.querySelector("fn-datepicker");
      datepicker.setAttribute("data-timestamp", params.query_params.end_time);

      var daterangepicker = this.querySelector("fn-daterangepicker");
      daterangepicker.setAttribute("data-endtime", params.query_params.end_time);
    };

    this.handleAggregationDisplay = function() {
      var view = this.getQueryParamOrDefaultValue("view");
      var time_window = this.querySelector("#time_window");
      var time_step = this.querySelector("#time_step");
      if (view == "value" || view.substr(0,6) == "rollup") {
        time_window.setAttribute("disabled", "disabled");
        time_step.setAttribute("disabled", "disabled");
      } else {
        time_window.removeAttribute("disabled");
        time_step.removeAttribute("disabled");
      }

        
    };

    this.initControls = function() {
      var base = this;
      var rollup = this.querySelector("#rollup");
      rollup.setOptions([
        "Value", "Sum", "Count", "Min",
        "Max", "Mean", "Median", "Rollup Mean",
        "Rollup Count", "Rollup Sum"]);

      rollup.setValue(
        FnordMetric.util.toTitleCase(this.getQueryParamOrDefaultValue("view")));

      var time_window_options = [
        "1 second", "5 seconds", "10 seconds", "20 seconds", "30 seconds", 
        "1 minute", "5 minues", "15 minutes", "30 minutes", "1 hour",
        "2 hours", "6 hours", "12 hours", "24 hours"];

      var time_window = this.querySelector("#time_window");
      time_window.setOptions(time_window_options);
      time_window.setValue(
        FnordMetric.util.parseMilliTS(this.getQueryParamOrDefaultValue("t_window")));

      var time_step = this.querySelector("#time_step");
      time_step.setOptions(time_window_options);
      time_step.setValue(
        FnordMetric.util.parseMilliTS(this.getQueryParamOrDefaultValue("t_step")));

      var time_range = this.querySelector("#timerange");
      time_range.setOptions([
        "5 minutes","15 minutes", "30 minutes", 
        "1 hour", "4 hours", "12 hours", "1 day"]);
      time_range.setValue(
        FnordMetric.util.parseMilliTS(this.getQueryParamOrDefaultValue("time_range")));


      var datepicker = this.querySelector("fn-datepicker");
      datepicker.setAttribute(
        'data-timestamp', this.getQueryParamOrDefaultValue("end_time") );

      var daterangepicker = this.querySelector("fn-daterangepicker");
      daterangepicker.setAttribute(
        'data-daterange', this.getQueryParamOrDefaultValue("time_range"));

      daterangepicker.setAttribute(
        'data-endtime', this.getQueryParamOrDefaultValue("end_time"));

      

      //set all controls event listeners
      rollup.addEventListener("fn-dropdown-select", function() {
        base.updateUrlParams("view", this.getValue().toLowerCase());
        base.handleAggregationDisplay();
      }, false);

      time_window.addEventListener("fn-dropdown-select", function() {
        base.updateUrlParams(
          "t_window", FnordMetric.util.toMilliSeconds(this.getValue()));
      }, false);

      time_step.addEventListener("fn-dropdown-select", function() {
        base.updateUrlParams(
          "t_step", FnordMetric.util.toMilliSeconds(this.getValue()));
      }, false);

      time_range.addEventListener("fn-dropdown-select", function() {
        var endtime = base.getQueryParamOrDefaultValue("end_time");
        var date_range = FnordMetric.util.toMilliSeconds(this.getValue());
        var starttime = parseInt(endtime, 10) - date_range;
        base.updateUrlParams("start_time", starttime);
        daterangepicker.setAttribute("data-daterange", date_range);
      }, false);

      datepicker.addEventListener('fn-datepicker-select', function() {
        base.updateUrlParams("end_time", this.getAttribute("data-timestamp"));
        base.updateDateTimeElems();
      }, false);

      daterangepicker.addEventListener('fn-daterangepicker-select-previous', 
        function() {
          base.updateUrlParams("end_time", this.getAttribute("data-endtime"));
          base.updateDateTimeElems();
      }, false);

      daterangepicker.addEventListener('fn-daterangepicker-select-next',
        function() {
          base.updateUrlParams("end_time", this.getAttribute("data-endtime"));
          base.updateDateTimeElems();
      }, false);
    }


    /*
    controls_primary --> get & set button value
    controls_secondary --> get & set button values

    renderchart
    rendertable

    runquery
    */
  }
  
  window.addEventListener("fn-ready", function() {
    Fnord.registerComponent(
      "fnordmetric-metric-preview",
      FnordMetricMetricPreviewComponent);
  }, false);
</script>
