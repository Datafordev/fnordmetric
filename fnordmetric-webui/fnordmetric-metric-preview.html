<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<template id="fnordmetric-metric-preview-base-tpl">
  <fn-loader>
    <h1 class="page_header"><i>Metric</i> &rsaquo; </h1>
    <fn-controls type='primary'>
      <fn-controls-section data-position='left'>
        <div class='group aggregation_type'>
          <b>Rollup</b>
          <fn-dropdown id='rollup'>
          </fn-dropdown>
        </div>
        <div class='group aggregation_time_window'>
          <b>Time Window / Step</b>
          <fn-dropdown id='time_window'>
          </fn-dropdown>
          <fn-dropdown id='time_step'>
          </fn-dropdown>
        </div>
      </fn-controls-section>
      <fn-controls-section data-position='right'>
        <div class='group timespan'>
          <b>Show The Last...</b>
          <fn-dropdown id='timespan'>
          </fn-dropdown>
        </div>
        <div class='group date'>
          <b>End Time</b>
          <fn-datepicker time-select='input'>
          </fn-datepicker>
        </div>
      </fn-controls-section>
    </fn-controls>
    <fn-controls type='secondary'>
      <fn-controls-section data-position='left'>
        <fn-button>
          Open in Editor
        </fn-button>
        <fn-button>
          Embed
        </fn-button>
      </fn-controls-section>
      <fn-controls-section data-position='right'>
        <fn-button>
          Timespan
        </fn-button>
      <fn-controls-section>
    </fn-controls>
  </fn-loader>
</template>

<script type="text/javascript">
  var FnordMetricMetricPreviewComponent = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate("fnordmetric-metric-preview", "base");
      this.appendChild(tpl);

      var controls = this.querySelector("fn-controls");
      var header = this.querySelector(".page_header");
      var params;
      var query;

      if (this.getAttribute('data-url') != null) {
        params = FnordMetric.util.parseQueryString(
          this.getAttribute("data-url"));
        query =
          FnordMetric.util.generateSQLQueryFromParams(params.query_params);

        header.innerHTML += params.query_params.innerViewValue;
        this.initControls();
      } else {
        this.attributeChangedCallback = function(attr, old_val, new_val) {
          if (attr == "data-url") {
            params = FnordMetric.util.parseQueryString(
              this.getAttribute("data-url"));
            query =
              FnordMetric.util.generateSQLQueryFromParams(params.query_params);

            header.innerHTML += params.query_params.innerViewValue;
          }
        }
      }
    };

    this.getQueryParamOrDefaultValue = function(key) {
      var defaults = {
        view : "value",
        columns: "",
        end_time : Date.now(),
        /* 5 minutes  */
        time_to_end : 3600000,
        /* 1 second */
        t_step : 10000,
        t_window : 5000,
        by: ""
      }

      var params = FnordMetric.util.parseQueryString(
          this.getAttribute("data-url"));


      var value = (params.query_params[key] == undefined)?
        defaults[key] : params.query_params[key];


      return value;

    }

    this.initControls = function() {
      var rollup = this.querySelector("#rollup");
      console.log(rollup);
      rollup.setOptions(["Value", "Sum", "Count"]);
      //to Title Case
      /*rollup.setValue(
        this.getQueryParamOrDefaultValue("view"));*/

      rollup.setValue("Value");

      var datepicker = this.querySelector("fn-datepicker");
      datepicker.setAttribute('data-timestamp', Date.now() );
    }


    /*
    controls_primary --> get & set button value
    controls_secondary --> get & set button values

    renderchart
    rendertable

    runquery
    */
  }
  
  window.addEventListener("fn-ready", function() {
    Fnord.registerComponent(
      "fnordmetric-metric-preview",
      FnordMetricMetricPreviewComponent);
  }, false);
</script>
