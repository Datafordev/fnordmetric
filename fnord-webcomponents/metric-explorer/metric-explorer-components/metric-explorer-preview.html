<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->

<template id="fn-metric-explorer-preview-base-tpl">
  <style type='text/css'>
    fn-button#auto_refresh[auto-refresh-on='on'] {
      color : #009fe9;
    }
    .group.group_by fn-button[data-active='active'] {
      background: rgb(226, 232, 237);
    }
    .group.group_by fn-button {
      float: left;
    }
    .group.aggregation_time_window {
      border-right: 1px solid rgb(226, 232, 237);
    }
    .group.aggregation_time_window fn-dropdown {
      float:left;
      margin-right: 20px;
    }
    .group.aggregation_time_window fn-dropdown:last-child {
      margin-right: 0;
    }
    .group.aggregation_type {
      border-right: 1px solid rgb(226, 232, 237);
    }
    .group b {
      font-weight: normal;
      font-size: 80%;
      line-height: 12px;
      font-weight: 500;
      display: block;
      margin-bottom: 6px;
      opacity: 0.7;
    }
    .group {
      height: 100%;
      float: left;
      padding: 14px 20px 0 20px;
    }
    fn-controls[type='secondary'] fn-button {
      box-shadow:none;
    }
    #result_pane fn-message {
      display:none;
      margin: 2em 4em;
    }
    #result_pane fn-message.active {
      display: block;
    }
    .result_pane {
      display:none;
    }
    .result_pane.active {
      display:block;
    }
    .result_pane fn-pager.table {
      float:right;
      margin-right: 5px;
    }
  </style>
  <fn-loader>
    <h1 class="page_header">
      <fn-button id="metric-list">
        <i>Metric</i>
      </fn-button>
      &rsaquo;
      <span></span>
    </h1>
    <fn-controls type='primary'>
      <fn-controls-section data-position='left'>
        <div class='group aggregation_type'>
          <b>Rollup</b>
          <fn-dropdown id='rollup' data-style="input small">
            <fn-dropdown-header>Value</fn-dropdown-header>
            <fn-dropdown-item data-value='value'>Value</fn-dropdown-item>
            <fn-dropdown-item data-value='sum'>Sum</fn-dropdown-item>
            <fn-dropdown-item data-value='min'>Min</fn-dropdown-item>
            <fn-dropdown-item data-value='max'>Max</fn-dropdown-item>
          </fn-dropdown>
        </div>
        <div class='group aggregation_time_window'>
          <b>Time Window / Step</b>
          <fn-dropdown id='time_window' data-style="input small">
            <fn-dropdown-header>5 seconds</fn-dropdown-header>
            <fn-dropdown-item data-value=1>1 second</fn-dropdown-item>
            <fn-dropdown-item data-value=5>5 seconds</fn-dropdown-item>
            <fn-dropdown-item data-value=10>10 seconds</fn-dropdown-item>
            <fn-dropdown-item data-value=20>20 seconds</fn-dropdown-item>
            <fn-dropdown-item data-value=30>30 seconds</fn-dropdown-item>
            <fn-dropdown-item data-value=60>1 minute</fn-dropdown-item>
            <fn-dropdown-item data-value=300>5 minutes</fn-dropdown-item>
            <fn-dropdown-item data-value=900>15 minutes</fn-dropdown-item>
            <fn-dropdown-item data-value=1800>30 minutes</fn-dropdown-item>
            <fn-dropdown-item data-value=3600>1 hour</fn-dropdown-item>
            <fn-dropdown-item data-value=7200>2 hours</fn-dropdown-item>
            <fn-dropdown-item data-value=21600>6 hours</fn-dropdown-item>
            <fn-dropdown-item data-value=43200>12 hours</fn-dropdown-item>
            <fn-dropdown-item data-value=86400>24 hours</fn-dropdown-item>
          </fn-dropdown>
          <fn-dropdown id='time_step' data-style="input small">
            <fn-dropdown-header>5 seconds</fn-dropdown-header>
            <fn-dropdown-item data-value=1>1 second</fn-dropdown-item>
            <fn-dropdown-item data-value=5>5 seconds</fn-dropdown-item>
            <fn-dropdown-item data-value=10>10 seconds</fn-dropdown-item>
            <fn-dropdown-item data-value=20>20 seconds</fn-dropdown-item>
            <fn-dropdown-item data-value=30>30 seconds</fn-dropdown-item>
            <fn-dropdown-item data-value=60>1 minute</fn-dropdown-item>
            <fn-dropdown-item data-value=300>5 minutes</fn-dropdown-item>
            <fn-dropdown-item data-value=900>15 minutes</fn-dropdown-item>
            <fn-dropdown-item data-value=1800>30 minutes</fn-dropdown-item>
            <fn-dropdown-item data-value=3600>1 hour</fn-dropdown-item>
            <fn-dropdown-item data-value=7200>2 hours</fn-dropdown-item>
            <fn-dropdown-item data-value=21600>6 hours</fn-dropdown-item>
            <fn-dropdown-item data-value=43200>12 hours</fn-dropdown-item>
            <fn-dropdown-item data-value=86400>24 hours</fn-dropdown-item>
          </fn-dropdown>
        </div>
        <div class="group scale">
          <b>Scale</b>
          <fn-checkbox data-style="small">
            <fn-checkbox-label>Inverted</fn-checkbox-label>
          </fn-checkbox>
          <fn-checkbox data-style="small">
            <fn-checkbox-label>Logarithmic</fn-checkbox-label>
          </fn-checkbox>
        </div>
      </fn-controls-section>
      <fn-controls-section data-position='right'>
        <div class='group timerange'>
          <b>Show The Last...</b>
          <fn-dropdown id='timerange' data-style="input small">
            <fn-dropdown-header>1 hour</fn-dropdown-header>
            <fn-dropdown-item data-value=300>5 minutes</fn-dropdown-item>
            <fn-dropdown-item data-value=900>15 minutes</fn-dropdown-item>
            <fn-dropdown-item data-value=1800>30 minutes</fn-dropdown-item>
            <fn-dropdown-item data-value=3600>1 hour</fn-dropdown-item>
            <fn-dropdown-item data-value=14400>4 hours</fn-dropdown-item>
            <fn-dropdown-item data-value=43200>12 hours</fn-dropdown-item>
            <fn-dropdown-item data-value=86400>1 day</fn-dropdown-item>
          </fn-dropdown>
        </div>
        <div class='group date'>
          <b>End Time</b>
          <fn-datepicker data-time-select data-selectable="past">
          </fn-datepicker>
        </div>
      </fn-controls-section>
    </fn-controls>
    <fn-controls type='secondary'>
      <fn-controls-section data-position='left'>
        <fn-button id="embed_btn">
          <i class='fa fa-share'></i>
          Embed
        </fn-button>
        <fn-button id="auto_refresh">
          <i class='fa fa-refresh'></i>
          Auto Refresh
        </fn-button>
      </fn-controls-section>
      <fn-controls-section data-position='right'>
        <fn-daterangepicker past-selectable='selectable'>
        </fn-daterangepicker>
      <fn-controls-section>
    </fn-controls>
    <fn-loader id="result_pane" data-transparent>
      <div id="result_pane_chart">
      </div>
      <fn-table data-per-page='25' style="width:100%;">
      </fn-table>
    </fn-loader>
  </fn-loader>
</template>

<script type='text/javascript'>
  var MetricExplorerPreview = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate("fn-metric-explorer-preview", "base");
      this.appendChild(tpl);

      if (this.getAttribute('data-url') != null) {
        this.onUrlChange(true)
      }
    }

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      if (attr == 'data-url') {
        var init = (old_val == null);

        this.onUrlChange(init);
      }
    }

    this.onUrlChange = function(init) {
      this.params = parseUrlQueryString(this.getAttribute("data-url"));

      //var queryUrl = generateQueryUrl(this.params.query_params);
      this.setHeader();

      if (init) {
        this.init();
        //this.handleAggregationDisplay();
      }

      //this.runQuery
    }

    this.setHeader = function() {
      this.querySelector("h1 span").innerHTML =
        this.params.query_params.innerViewValue;
    }

    this.init = function() {
      var url = 
        "https://rpc.fnrd.net/cm-stats/metrics/list?filter=" +
        encodeURIComponent(this.params.query_params.innerViewValue);


        /*base.updateUrlParams(
          base.addRequiredURLParamsForView(
            base.getQueryParamOrDefaultValue("view")));*/
      this.initControls();

    };


    this.updateUrlParams = function(new_params) {
      var params = parseUrlQueryString(this.getAttribute("data-url"));
      for (var key in new_params) {
        if (new_params[key] != undefined) {
          params.query_params[key] = new_params[key].toString();
        }
      }
      var path = setURLFromQueryString("metric", params.query_params, true);
      this.setAttribute("data-url", path);
    };

    this.updateDateTimeElems = function(end_time) {
      var params = FnordMetric.util.parseQueryString(
          this.getAttribute("data-url"));
      var date_range = this.getQueryParamOrDefaultValue("time_range");
      var start_time = parseInt(end_time, 10) - parseInt(date_range, 10);
      this.updateUrlParams({"end_time" : end_time, "start_time" : start_time});
      var datepicker = this.querySelector("fn-datepicker");
      datepicker.setAttribute("data-timestamp", end_time * 1000);
      var daterangepicker = this.querySelector("fn-daterangepicker");
      daterangepicker.setAttribute("data-endtime", end_time * 1000);
    };

    this.getQueryParamOrDefaultValue = function(key) {
      var defaults = {
        view : "value",

        end_time : Math.round(Date.now() / 1000),
        /* 5 minutes  */
        time_range : 3600,
        /* 10, 5 seconds */
        t_step : 10,
        t_window : 5

      }

      if (key == "time_range") {
        var end_time = parseInt(this.getQueryParamOrDefaultValue("end_time"), 10);
        var start_time = parseInt(this.params['start_time'], 10);
        if (!isNaN(start_time)) {
          return end_time - start_time;
        } else {
          return defaults['time_range'];
        }
      }

      var value = (this.params[key] == undefined)?
        defaults[key] : params.query_params[key];
      return value;
    };

    this.initControls = function() {
      var base = this;
      var rollup = this.querySelector("#rollup");
      var view = this.getQueryParamOrDefaultValue("view");
      rollup.setAttribute('data-preselected', view);

      var time_window = this.querySelector("#time_window");
      var t_window_val = this.getQueryParamOrDefaultValue("t_window");
      time_window.setAttribute('data-preselected', t_window_val);

      var time_step = this.querySelector("#time_step");
      var t_step_val = this.getQueryParamOrDefaultValue("t_step");
      time_step.setAttribute('data-preselected', t_step_val);

     var time_range_val = parseInt(
        this.getQueryParamOrDefaultValue("time_range"), 10);
      var end_time = parseInt(this.getQueryParamOrDefaultValue("end_time"), 10);

      var time_range = this.querySelector("#timerange");
      time_range.setAttribute('data-preselected', time_range_val);

      var datepicker = this.querySelector("fn-datepicker");
      datepicker.setAttribute('data-timestamp', (end_time * 1000));

      var daterangepicker = this.querySelector("fn-daterangepicker");
      daterangepicker.setAttribute('data-daterange', (time_range_val * 1000));
      daterangepicker.setAttribute('data-endtime', (end_time * 1000));

      //set controls event listeners
      rollup.addEventListener("fn-dropdown-item-click", function(e) {
        var view = e.srcElement.getAttribute('data-value');
        var new_params = base.addRequiredURLParamsForView(view);
        new_params.view = view;
        base.updateUrlParams(new_params);
        base.handleAggregationDisplay();
      }, false);

      time_window.addEventListener("fn-dropdown-item-click", function(e) {
        var value = e.srcElement.getAttribute('data-value');
        base.updateUrlParams({"t_window": value});
      }, false);

      time_step.addEventListener("fn-dropdown-select", function(e) {
        var value = e.srcElement.getAttribute('data-value');
        base.updateUrlParams({"t_step": value});
      }, false);

      time_range.addEventListener("fn-dropdown-item-click", function(e) {
        var endtime = base.getQueryParamOrDefaultValue("end_time");
        var date_range = parseInt(e.srcElement.getAttribute('data-value'));
        var starttime = parseInt(endtime, 10) - date_range;
        base.updateUrlParams({"start_time": starttime});
        //check
        daterangepicker.setAttribute("data-daterange", (date_range * 1000));
      }, false);

      datepicker.addEventListener('fn-datepicker-select', function() {
        var timestamp = parseInt(this.getAttribute("data-timestamp"), 10);
        timestamp = Math.round(timestamp / 1000);
        base.updateDateTimeElems(timestamp);
      }, false);

      daterangepicker.addEventListener('fn-daterangepicker-select-previous', 
        function() {
          var endtime = parseInt(this.getAttribute("data-endtime"), 10);
          endtime = Math.round(endtime / 1000);
          base.updateDateTimeElems(endtime);
      }, false);

      daterangepicker.addEventListener('fn-daterangepicker-select-next',
        function() {
          var endtime = parseInt(this.getAttribute("data-endtime"), 10);
          endtime = Math.round(endtime / 1000);
          base.updateDateTimeElems(endtime);
      }, false);

    }

  }

  window.addEventListener('fn-ready', function() {
    Fnord.registerComponent('fn-metric-explorer-preview', MetricExplorerPreview);
  }, false);
</script>


