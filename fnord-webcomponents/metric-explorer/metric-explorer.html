<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<html>
  <head>
    <title>Metric Explorer</title>
    <link rel="stylesheet" href="../fnord.css" type="text/css">
    <link rel="stylesheet" href="../3rdparty/fontawesome.css" type="text/css">
    <link rel="stylesheet" href="../3rdparty/fontawesome.woff" type="text/css">
    <link rel="stylesheet" href="fn-metric-explorer.css" type="text/css">
    <link rel="stylesheet" href="../components/fn-button.css" type="text/css">
    <link rel="stylesheet" href="../components/fn-input.css" type="text/css">
    <link rel="stylesheet" href="../components/fn-table.css" type="text/css">
    <link rel="stylesheet" href="../components/fn-pager.css" type="text/css">
    <link rel="stylesheet" href="../components/fn-message.css" type="text/css">
  </head>
  <body>
    <link rel="import" href="metric-explorer-components/metric-explorer-list.html" data-component="fn-metric-explorer-list">
    <link rel="import" href="metric-explorer-components/metric-explorer-search.html" data-component="fn-metric-explorer-search">
    <link rel="import" href="metric-explorer-components/metric-explorer-preview.html" data-component="fn-metric-explorer-preview">
    <link rel="import" href="../components/fn-appbar.html" data-component="fn-appbar">
    <link rel="import" href="../components/fn-button.html" data-component="fn-button">
    <link rel="import" href="../components/fn-loader.html" data-component="fn-loader">
    <link rel="import" href="../components/fn-menu.html" data-component="fn-menu">
    <link rel="import" href="../components/fn-search.html" data-component="fn-search">
    <link rel="import" href="../components/fn-table.html" data-component="fn-table">
    <link rel="import" href="../components/fn-progressbar.html" data-component="fn-progressbar">
    <link rel="import" href="../components/fn-dropdown.html" data-component="fn-dropdown">
    <link rel="import" href="../components/fn-controls.html" data-component="fn-controls">
    <link rel="import" href="../components/fn-datepicker.html" data-component="fn-datepicker">
    <link rel="import" href="../components/fn-daterangepicker.html" data-component="fn-daterangepicker">
    <link rel="import" href="../components/fn-input.html" data-component="fn-input">
    <link rel="import" href="../components/fn-checkbox.html" data-component="fn-checkbox">
    <link rel="import" href="../components/fn-timeinput.html" data-component="fn-input-time">
    <link rel="import" href="../components/fn-pager.html" data-component="fn-pager">
    <link rel="import" href="../components/fn-message.html" data-component="fn-message">
    <link rel="stylesheet" href="../themes/midnight-blue.css" type="text/css">


    <div id="metric-explorer-viewport">
    </div>


  </body>
</html>

<script type='text/javascript'>
  //var baseUrl = "https://rpc.fnrd.net/cm-stats/metrics";
  var baseUrl = "http://127.0.0.1:8000/metrics/";
  var views = {
    "metrics" : "<fn-metric-explorer-list></fn-metric-explorer-list>",
    "metric" : "<fn-metric-explorer-preview></fn-metric-explorer-preview>",
    "search" : "<fn-metric-explorer-list></fn-metric-explorer-list>"
  }


  var routes = {
    "metrics": "fn-metric-explorer-list",
    "metric": "fn-metric-explorer-preview",
    "search": "fn-metric-explorer-list"
  };

  var default_route = "metrics";


  function openUrl(raw_url, push_state) {
    var url = parseUrlQueryString(raw_url);
    var query_params = url["query_params"];

    var view_name = routes[url["path"]];

    if (view_name == undefined) {
      alert("no route found for: " + url["path"]);
      return;
    }

    if (typeof push_state == "undefined" || push_state === true) {
      window.history.pushState({url: raw_url}, "", "#" + raw_url);
    }

    var viewport = document.querySelector("#metric-explorer-viewport");
    var view = document.createElement(view_name);
    view.setAttribute("data-url", raw_url);
    viewport.innerHTML = "";
    viewport.appendChild(view);

  };


  function parseUrlQueryString(qstr) {
    if (qstr == null) {return;}
    var path;
    var query_params = {};

    if (qstr.indexOf("?") >= 0) {
      path = qstr.substr(0, qstr.indexOf("?"));
      path = path.replace("#", "");

      var params_str = qstr.substr(qstr.indexOf("?") + 1);
      var raw_params = params_str.split('&');

      /* set first param which defines view's view (metric, search ...) */
      var param = raw_params[0].split('=');
      query_params.innerView = decodeURIComponent(param[0]);
      query_params.innerViewValue = decodeURIComponent(param[1]);

      for (var i = 1; i < raw_params.length; i++) {
        var param = (raw_params[i].split('=') != "undefined") ? 
          raw_params[i].split('=') : "";
        if (param[0] != "undefined") {
          query_params[decodeURIComponent(param[0])] =
             (param[1] != "undefined") ? 
             decodeURIComponent(param[1]) : "";
        }
      }

    } else {
      path = qstr != "undefined" ? qstr : "";
    }
    return {
      "path": path,
      "query_params": query_params
    }
  };

  function setUrlFromQueryString(hash, query_params, push_state) {
    if (hash === undefined || hash === "undefined") {
      window.location.hash = "";
      return;
    }
    var path = "#" + hash;

    if ("innerView" in query_params && query_params.innerView != undefined) {
      path += "?" + encodeURIComponent(query_params.innerView) + "=";
      path +=
        encodeURIComponent(query_params.innerViewValue);

      for (var param in query_params) {
        if (param != "innerView" && 
            param != "innerViewValue" &&
            query_params[param] != undefined &&
            query_params[param].length > 0) {

          path += 
            "&" + encodeURIComponent(param) +
            "=" + encodeURIComponent(query_params[param]);
        }
      }
    }

    if (push_state) {
      window.history.pushState({url:path}, "#", path);
    }
    window.location.hash = path;
    return path;
  }

  window.addEventListener('fn-ready' ,function() {
    var fragment = window.location.hash;
    if (fragment) {
      openUrl(fragment.substring(1));
    } else {
      openUrl(default_route);
    }

  }, false)
</script>
<script type='text/javascript' src='../fnord.js'></script>
