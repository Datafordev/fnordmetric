<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<template id="fn-splitpane-base-tpl">
  <style>
     fn-splitpane-left, fn-splitpane-right{
      position: absolute;
      box-sizing: border-box;
      color: #959595;
    }

    .resizer_tooltip {
      display:block;
      z-index: 100;
      background: #d7e4f2;
      position:absolute;

    }

    .resizer_tooltip:hover {
      background: #d7e4f2;
    }


  </style>
  <fn-splitpane-left>
    <content></content>
  </fn-splitpane-left>
  <div class="resizer_tooltip"></div>
  <fn-splitpane-right>
    <content></content>
  </fn-splitpane-right>
</template>

<script type="text/javascript">
  var SplitPaneComponent = function() {
    this.createdCallback = function() {
      var shadow = this.createShadowRoot();
      var tpl = Fnord.getTemplate("fn-splitpane", "base");
      shadow.appendChild(tpl);
      var base = this;

      this.init();

      document.addEventListener("DOMContentLoaded", function() {
        base.renderView();
      }, false);

      this.initResizerTooltip();
    };

    this.init = function() {
      this.style.display = "block";
      this.style.height = "100%";
    };

    this.renderView = function() {
      if (this.getAttribute("data-split") == "horizontal") {
        this.renderHorizontalView();
      } else {
        this.renderVerticalView();
      }
    };


    this.initResizerTooltip = function() {
      var base = this;
      var resizer_tooltip = this.shadowRoot.querySelector(".resizer_tooltip");
      resizer_tooltip.setAttribute("draggable", "true");

      var benchmark_x;
      var benchmark_y;

      resizer_tooltip.addEventListener('dragstart', function(e) {
        this.style.background = "transparent";
        benchmark_x = e.clientX;
        benchmark_y = e.clientY;
      }, false);

      resizer_tooltip.addEventListener('drag', function(e) {
        e.preventDefault();
        this.style.background = "";
        if (base.getAttribute("data-split") == "horizontal") {
          //include window/pageYOffset ??
          base.resizeHorizontalView(benchmark_y - e.clientY);
          benchmark_y = e.clientY;
        } else {
          base.resizeVerticalView(benchmark_x - e.clientX);
          benchmark_x = e.clientX;
        }
      }, false);
    };

    this.resizeVerticalView = function(offset) {
      var left_pane = this.shadowRoot.querySelector("fn-splitpane-left");
      var right_pane = this.shadowRoot.querySelector("fn-splitpane-right");
      var resizer_tooltip = this.shadowRoot.querySelector(".resizer_tooltip");

      var left_pane_width = left_pane.offsetWidth - offset;
      var right_pane_width = this.offsetWidth - left_pane_width;

      if (left_pane_width > 350 && right_pane_width > 350) {
        left_pane.style.width = left_pane_width + "px";
        right_pane.style.width = right_pane_width + "px";
        right_pane.style.marginLeft = left_pane_width + "px";
        resizer_tooltip.style.marginLeft = left_pane_width + "px";
      }
    };

    this.resizeHorizontalView = function(offset) {
      var left_pane = this.shadowRoot.querySelector("fn-splitpane-left");
      var right_pane = this.shadowRoot.querySelector("fn-splitpane-right");
      var resizer_tooltip = this.shadowRoot.querySelector(".resizer_tooltip");

      var left_pane_height = left_pane.offsetHeight - offset;
      var right_pane_height = this.offsetHeight- left_pane_height;

      if (left_pane_height > 200 && right_pane_height > 200) {
        left_pane.style.height = left_pane_height + "px";
        right_pane.style.height = right_pane_height + "px";
        right_pane.style.marginTop = left_pane_height + "px";
        resizer_tooltip.style.marginTop = left_pane_height + "px";
      }
    };

    this.getPaneWidths = function() {
      var left_relative = this.getAttribute('left-width-relative');
      if (left_relative != null) {
        return {
          left : left_relative + "%",
          right: 100 - parseInt(left_relative, 10) + "%"};
      }

      var right_relative = this.getAttribute('right-width-relative');
      if (right_relative != null) {
        return {
          left : 100 - parseInt(right_relative, 10) + "%",
          right : right_relative + "%"};
      }

      var left_absolute = this.getAttribute('left-width-absolute');
      if (left_absolute != null) {
        var width = this.offsetWidth();
        return {
          left : left_absolute + "px",
          right : width - parseInt(left_absolute, 10) + "px"};
      }

      var right_absolute = this.getAttribute('right-width-absolute');
      if (right_absolute != null) {
        var width = this.offsetwidth();
        return {
          left : width - parseInt(right_absolute, 10) + "px",
          right : right_absolute + "px"};
      }

      var width = this.offsetWidth / 2;
      return {
        left : width + "px",
        right : width + "px"};
    }


    this.renderVerticalView = function() {
      console.log("render vertical view");
      var left_pane = this.shadowRoot.querySelector("fn-splitpane-left");
      var right_pane = this.shadowRoot.querySelector("fn-splitpane-right");
      var resizer_tooltip = this.shadowRoot.querySelector(".resizer_tooltip");

      var widths = this.getPaneWidths();
      var left_pane_height = this.offsetHeight;
      console.log(widths);

      left_pane.style.width = widths.left;
      left_pane.style.height = left_pane_height + "px";

      right_pane.style.width = widths.right;
      right_pane.style.height = left_pane_height + "px";
      right_pane.style.marginLeft = widths.left;
      right_pane.style.marginTop = "";
      right_pane.style.overflowY = "auto";

      resizer_tooltip.style.height = left_pane_height + "px";
      resizer_tooltip.style.marginLeft = widths.left;
      resizer_tooltip.style.marginTop = "";
      resizer_tooltip.style.width = "5px";
      resizer_tooltip.style.cursor = "ew-resize";


      /*var left_pane_width = this.offsetWidth / 2;
      left_pane.style.width = left_pane_width + "px";
      left_pane.style.height = left_pane_height + "px";

      right_pane.style.width = left_pane_width + "px";
      right_pane.style.height = left_pane_height + "px";
      right_pane.style.marginLeft = left_pane_width + "px";
      right_pane.style.marginTop = "";
      right_pane.style.overflowY = "auto";

      resizer_tooltip.style.height = left_pane_height + "px";
      resizer_tooltip.style.marginLeft = left_pane_width + "px";
      resizer_tooltip.style.marginTop = "";
      resizer_tooltip.style.width = "5px";
      resizer_tooltip.style.cursor = "ew-resize";*/
    };

    this.renderHorizontalView = function() {
      var left_pane = this.shadowRoot.querySelector("fn-splitpane-left");
      var right_pane = this.shadowRoot.querySelector("fn-splitpane-right");
      var resizer_tooltip = this.shadowRoot.querySelector(".resizer_tooltip");

      var height = this.offsetHeight / 2;
      var width = this.offsetWidth;

      left_pane.style.width = width + "px";
      left_pane.style.height = height + "px";

      right_pane.style.width = width + "px";
      right_pane.style.height = height + "px";
      right_pane.style.marginLeft = "0px";
      right_pane.style.marginTop = (height +3) + "px";

      resizer_tooltip.style.marginTop = height + "px";
      resizer_tooltip.style.marginLeft = "0px";
      resizer_tooltip.style.width = width + "px";
      resizer_tooltip.style.height = "5px";
      resizer_tooltip.style.cursor = "ns-resize";
    };

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      if (attr == "data-split") {
        this.renderView();
      }
    }
  };

  window.addEventListener('fn-ready', function() {
    var splitpane = Fnord.registerComponent("fn-splitpane", SplitPaneComponent);
  });
</script>
